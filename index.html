<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°éŒ¯ç©ºé–“ v25.18 (Log Edit & Date + SOP)</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#202124">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        :root { --bg-color: #202124; --surface-color: #303134; --text-primary: #e8eaed; --text-secondary: #9aa0a6; --divider: #3c4043; --blue: #8ab4f8; --red: #f28b82; --green: #81c995; --yellow: #fdd663; --orange: #fcad70; --purple: #c58af9; --teal: #64ffda; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-primary); -webkit-tap-highlight-color: transparent; padding-bottom: 90px; overscroll-behavior-y: none; }
        button, input, textarea, select { font-family: inherit; }
        header { background-color: var(--surface-color); padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--divider); display: flex; align-items: center; justify-content: center; }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 500; }
        .header-back { position: absolute; left: 15px; background: none; border: none; font-size: 1rem; color: var(--blue); cursor: pointer; display: none; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .page { display: none; } .page.active { display: block; }
        
        /* Overlays */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; color:white; font-size:1.2rem; flex-direction: column; gap:10px; text-align: center; padding: 20px;}
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .login-box { background: var(--surface-color); padding: 30px; border-radius: 12px; width: 100%; max-width: 320px; text-align: center; border: 1px solid var(--divider); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(0,0,0,0.2); border: 1px solid var(--divider); color: var(--text-primary); border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .login-btn { width: 100%; padding: 12px; background: var(--blue); color: #202124; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        
        /* Calendar */
        .calendar-section { background: var(--surface-color); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-day-name { color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 5px; }
        .cal-date { border-radius: 6px; font-size: 0.85rem; cursor: pointer; position: relative; height: 48px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 4px; background: rgba(255,255,255,0.02); }
        .cal-date.active { background-color: rgba(138, 180, 248, 0.2); color: var(--blue); font-weight: bold; border: 1px solid var(--blue); }
        .cal-bar-container { width: 100%; display: flex; flex-direction: column; gap: 2px; margin-top: 2px; align-items: center; }
        .cal-bar { width: 85%; height: 3px; border-radius: 2px; }
        .bar-design { background-color: var(--blue); } .bar-eng { background-color: var(--yellow); } .bar-warranty { background-color: var(--purple); }
        .event-list-box { margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--divider); font-size: 0.9rem; color: var(--text-secondary); min-height: 20px;}
        .event-item { margin-bottom: 8px; display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; cursor: pointer; background: rgba(255,255,255,0.03); }
        .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

        /* UI Elements */
        .alert-section { background-color: rgba(242, 139, 130, 0.15); border: 1px solid var(--red); border-radius: 12px; padding: 15px; margin-bottom: 20px; display: none; }
        .alert-item { color: var(--red); font-size: 0.9rem; margin-bottom: 8px; cursor: pointer; padding-bottom: 5px; border-bottom: 1px solid rgba(242, 139, 130, 0.3); }
        .project-card { background: var(--surface-color); border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid var(--divider); position: relative; overflow: hidden; cursor: pointer; z-index: 1; }
        .progress-bg { position: absolute; bottom: 0; left: 0; height: 4px; width: 100%; background: #444; z-index: 0; }
        .progress-fill { height: 100%; transition: width 0.3s; background: linear-gradient(to right, var(--green), var(--yellow)); }
        .tag { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
        .tag-track { background: var(--yellow); color: #333; } .tag-done { background: var(--green); color: #333; } .tag-suspend { background: var(--red); color: white; } .tag-warranty { background: var(--purple); color: white; }
        .card-progress-text { font-size: 0.85rem; color: var(--teal); margin-top: 5px; display: flex; align-items: center; gap: 5px; } .card-progress-text::before { content: 'â–º'; font-size: 0.7rem; }

        /* Detail Page */
        .detail-section { background: var(--surface-color); padding: 20px; border-radius: 12px; margin-bottom: 15px; }
        .detail-title { font-size: 0.9rem; font-weight: bold; color: var(--blue); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;}
        .input-row { margin-bottom: 15px; display: flex; flex-direction: column; } 
        .input-row-flex { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 15px; }
        .input-label { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px; display: block; }
        .detail-input { width: 100%; padding: 12px; box-sizing: border-box; background: #202124; border: 1px solid var(--divider); border-radius: 8px; font-size: 1rem; color: var(--text-primary); }
        .detail-input:focus { border-color: var(--blue); outline: none; }

        /* Stages List */
        .checklist-item { border-bottom: 1px solid var(--divider); padding: 15px 0; background: var(--surface-color); transition: background 0.1s; }
        .checklist-item.disabled { opacity: 0.4; } 
        .checklist-item.dragging { opacity: 0.4; background: #444; border: 1px dashed var(--blue); } 
        .check-header { display: flex; align-items: center; margin-bottom: 10px; justify-content: space-between; position: relative; z-index: 10; }
        
        .drag-handle { cursor: move; padding: 10px 15px 10px 0; color: var(--text-secondary); font-size: 1.5rem; display: flex; align-items: center; touch-action: none; }
        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 20px; margin-right: 10px; flex-shrink: 0; } .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; } .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: var(--blue); } input:checked + .slider:before { transform: translateX(14px); }
        
        .custom-checkbox { width: 22px; height: 22px; border: 2px solid var(--text-secondary); border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; flex-shrink: 0; transition: background 0.1s; cursor: pointer; color: transparent; font-weight: bold; }
        .checklist-item.checked .custom-checkbox, .custom-checkbox.checked { background: var(--green); border-color: var(--green); color: #202124; } 
        .checklist-item.checked .custom-checkbox::after, .custom-checkbox.checked::after { content: 'âœ“'; }
        
        .stage-details { margin-top: 10px; padding-left: 10px; border-left: 2px solid var(--divider); margin-left: 35px; }
        .date-row { display: flex; gap: 10px; margin-top: 8px; align-items: center; } .date-group { flex: 1; } .date-label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 2px; }
        
        .mini-date, .pay-date-input { width: 100%; background: #202124; border: 1px solid var(--divider); color: var(--text-primary); padding: 8px 4px; border-radius: 6px; font-size: 0.85rem; color-scheme: dark; height: 38px; box-sizing: border-box;}

        .btn-edit-mode { background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; cursor: pointer;}
        .btn-edit-mode.active { background: var(--blue); color: #202124; border-color: var(--blue); }
        .btn-add-stage { width: 100%; padding: 10px; margin-top: 10px; background: rgba(255,255,255,0.05); border: 1px dashed var(--text-secondary); color: var(--text-secondary); border-radius: 8px; cursor: pointer; }

        .log-input-area { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--divider); }
        .btn-add-log { background: var(--blue); color: #202124; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .log-list { margin-top: 10px; } .log-item { background: #2b2c2f; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--blue); position: relative; }
        .log-image { width: 100%; border-radius: 6px; margin-top: 10px; border: 1px solid var(--divider); }
        .log-delete { position: absolute; top: 10px; right: 10px; color: var(--red); background: none; border: none; cursor: pointer; font-size: 1.2rem; }
        .log-edit { position: absolute; top: 10px; right: 40px; color: var(--text-secondary); background: none; border: 1px solid var(--text-secondary); border-radius:12px; cursor: pointer; font-size: 0.8rem; padding: 2px 8px; }

        /* Payment Row Alignment */
        .payment-row { display: flex; flex-direction: row; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-top: 10px; }
        .pay-col-check { flex: 0 0 30px; display: flex; justify-content: center; align-items: center; }
        .pay-col-name { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; justify-content: center; }
        .pay-col-info { flex: 0 0 130px; display: flex; flex-direction: column; align-items: flex-end; gap: 6px; text-align: right; }
        
        .pay-name-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid transparent; color: var(--text-primary); padding: 4px 0; font-size: 1rem; font-weight: 500; }
        .pay-amount-input { width: 100px; background: #202124; border: 1px solid var(--divider); color: var(--yellow); text-align: right; border-radius: 6px; padding: 6px; font-weight: bold; font-size: 0.9rem; height: 38px; box-sizing: border-box; }
        .pay-date-input { width: 110px; }

        .pay-accordion-header { background: var(--surface-color); padding: 12px 15px; margin-top: 15px; border-radius: 8px; border-left: 5px solid var(--teal); display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; color: var(--teal); }
        .pay-accordion-header.collapsed::after { content: 'â–¶'; } .pay-accordion-header::after { content: 'â–¼'; font-size: 0.7rem; transition: transform 0.3s; }
        .pay-accordion-content.hidden { display: none; }

        .payment-tabs { display: flex; border-bottom: 1px solid var(--divider); margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; background: none; border: none; color: var(--text-secondary); border-bottom: 2px solid transparent; cursor: pointer; font-size: 1rem; } .tab-btn.active { color: var(--teal); border-bottom-color: var(--teal); font-weight: bold; }
        .payment-card { background: var(--surface-color); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid var(--teal); }

        .stage-selector { background: #202124; border: 1px solid var(--divider); color: var(--text-secondary); padding: 6px; border-radius: 4px; width: 100%; font-size: 0.8rem; height: 38px; box-sizing: border-box; }
        
        .menu-btn { display: block; width: 100%; padding: 20px; margin-bottom: 15px; background: var(--surface-color); color: var(--text-primary); border: 1px solid var(--divider); border-radius: 12px; font-size: 1.1rem; text-align: left; cursor: pointer; position: relative; } 
        .menu-btn .count-badge { float: right; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.9rem; color: var(--text-secondary); }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--blue); color: #202124; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 200; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; } .modal-content { background: var(--surface-color); padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; }
        .modal-sync { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .sync-box { background: var(--surface-color); padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--divider); }
        .sync-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--divider); }

        .action-bar { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; } .action-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 0.95rem; cursor: pointer; color: #202124; font-weight: bold; min-width: 100px;} 
        .detail-select { background: #202124; border: 1px solid var(--divider); color: var(--text-primary); border-radius: 4px; padding: 6px; font-size: 0.9rem; }
        .stage-control-row { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; border-top: 1px dashed var(--divider); padding-top: 8px; }
        .status-btn { background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); padding: 6px 10px; border-radius: 12px; font-size: 0.8rem; cursor: pointer; }
        .status-btn.active { color: #202124; font-weight: bold; border-color: transparent; }
        .status-btn.paid.active { background: var(--green); } .status-btn.unpaid.active { background: #666; color: white; } .status-btn.adv.active { background: var(--orange); }

        /* SOP Styles Alignment */
        .sop-header { background: rgba(252, 173, 112, 0.1); border-left: 5px solid var(--orange); padding: 12px; margin-top: 10px; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .sop-header::after { content: 'â–¼'; font-size: 0.7rem; transition: transform 0.3s; }
        .sop-header.collapsed::after { transform: rotate(-90deg); }
        .sop-content.hidden { display: none; }
        .sop-item-row { display: flex; align-items: center; gap: 10px; padding: 10px 5px; border-bottom: 1px dashed rgba(255,255,255,0.05); position: relative; }
        .sop-text { flex: 1; font-size: 0.95rem; line-height: 1.2; }
        .sop-date-input { width: 140px; background: #202124; border: 1px solid var(--divider); color: var(--text-primary); border-radius: 6px; padding: 8px 6px; font-size: 0.85rem; color-scheme: dark; height: 38px; box-sizing: border-box; }
        .sop-tab-container { display: flex; border-bottom: 1px solid var(--divider); margin-bottom: 15px; }
        .sop-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: var(--text-secondary); }
        .sop-tab.active { color: var(--orange); border-bottom: 2px solid var(--orange); font-weight: bold; }
        
        /* Template Editor Rows Alignment */
        .sop-tpl-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .sop-tpl-item-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding-left: 20px; }
        .btn-mini-del { background: none; border: none; color: var(--red); font-size: 1.2rem; cursor: pointer; flex-shrink: 0; padding: 5px; display: flex; align-items: center; justify-content: center; }
        .btn-sop-action { background: none; border: 1px solid var(--orange); color: var(--orange); padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; margin-top: 5px; }
        #advancement-alert { background: rgba(242, 139, 130, 0.2); border: 1px solid var(--red); color: var(--red); padding: 12px; margin-bottom: 20px; border-radius: 8px; display: none; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

    <div id="loading-overlay" style="display:none;"><div id="loading-msg">è³‡æ–™è¼‰å…¥ä¸­...</div></div>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-top:0; color:var(--blue);">å°éŒ¯ç©ºé–“å¯¦é©—å®¤</h2>
            <p style="color:var(--text-secondary); margin-bottom:20px;">è«‹ç™»å…¥ä»¥å­˜å–è³‡æ–™</p>
            <input type="email" id="login-email" class="login-input" placeholder="é›»å­ä¿¡ç®±">
            <input type="password" id="login-password" class="login-input" placeholder="å¯†ç¢¼">
            <button class="login-btn" onclick="performLogin()">ç™»å…¥</button>
            <div id="login-error" style="color:var(--red); font-size:0.9rem; margin-top:10px;"></div>
        </div>
    </div>

    <header>
        <button id="back-btn" class="header-back" onclick="goBack()">â€¹ è¿”å›</button>
        <h1 id="page-title">å°éŒ¯ç©ºé–“å¯¦é©—å®¤</h1>
        <button onclick="logout()" style="position:absolute; right:15px; background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.9rem;">ç™»å‡º</button>
    </header>

    <div id="home-page" class="page active container">
        <div id="alert-dashboard" class="alert-section">
            <div style="font-weight:bold; color:var(--red); margin-bottom:10px;">âš ï¸ é‡è¦æé†’</div>
            <div id="alert-list"></div>
        </div>
        <div class="calendar-section">
            <div class="calendar-header">
                <button onclick="changeMonth(-1)" style="font-size:1.5rem">â€¹</button>
                <span id="cal-month-year" style="font-weight:bold;"></span>
                <button onclick="changeMonth(1)" style="font-size:1.5rem">â€º</button>
            </div>
            <div class="calendar-grid"><div class="cal-day-name">æ—¥</div><div class="cal-day-name">ä¸€</div><div class="cal-day-name">äºŒ</div><div class="cal-day-name">ä¸‰</div><div class="cal-day-name">å››</div><div class="cal-day-name">äº”</div><div class="cal-day-name">å…­</div></div>
            <div id="calendar-days" class="calendar-grid"></div>
            <div id="calendar-events" class="event-list-box">é»æ“Šæ—¥æœŸæŸ¥çœ‹è¡Œç¨‹</div>
        </div>
        <button class="menu-btn" onclick="navigateTo('design-list-page')">è¨­è¨ˆæ¡ˆä»¶ <span id="cnt-design" class="count-badge">0</span></button>
        <button class="menu-btn" onclick="navigateTo('engineering-list-page')">å·¥ç¨‹æ¡ˆä»¶ <span id="cnt-eng" class="count-badge">0</span></button>
        <button class="menu-btn" onclick="navigateTo('warranty-list-page')" style="border-left: 5px solid var(--purple);">å®Œå·¥ä¿å›º <span id="cnt-warranty" class="count-badge">0</span></button>
        <button class="menu-btn" onclick="navigateTo('payment-page')" style="border-left: 5px solid var(--teal);">æ”¶æ¬¾é€²åº¦</button>
        <button class="menu-btn" onclick="navigateTo('sop-tpl-page')" style="border-left: 5px solid var(--orange);">SOP ç¯„æœ¬ç®¡ç†</button>
    </div>

    <!-- SOP ç¯„æœ¬ç®¡ç†é é¢ -->
    <div id="sop-tpl-page" class="page container">
        <div class="sop-tab-container">
            <div class="sop-tab active" id="sop-tab-design" onclick="switchSopTpl('design')">è¨­è¨ˆ SOP</div>
            <div class="sop-tab" id="sop-tab-eng" onclick="switchSopTpl('engineering')">å·¥ç¨‹ SOP</div>
        </div>
        <div id="sop-tpl-editor-container"></div>
        <button class="btn-add-stage" style="border-color:var(--orange); color:var(--orange); margin-top:20px; width:100%;" onclick="addSopTplHeader()">+ æ–°å¢ SOP æ¨™é¡Œ</button>
        <div style="margin-top:30px; border-top:1px solid var(--divider); padding-top:20px;">
            <p style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:10px;">å°‡æ­¤ç¯„æœ¬åŒæ­¥è‡³ç¾æœ‰æ¡ˆä»¶ (æ³¨æ„ï¼šæœƒä¾ç…§æ¨™é¡Œåç¨±æ¯”å°æ–°å¢)</p>
            <button style="background:none; border:1px solid var(--red); color:var(--red); padding:10px; border-radius:6px; width:100%; font-size:0.9rem; cursor:pointer;" onclick="syncSopToExisting()">åŒæ­¥ç¯„æœ¬è‡³ç¾æœ‰æ¡ˆä»¶</button>
        </div>
    </div>

    <div id="design-list-page" class="page container"><div id="design-list-container"></div><div class="fab" onclick="openAddModal('design')">+</div></div>
    <div id="engineering-list-page" class="page container"><div id="engineering-list-container"></div><div class="fab" onclick="openAddModal('engineering')">+</div></div>
    <div id="warranty-list-page" class="page container"><div id="warranty-list-container"></div></div>

    <div id="payment-page" class="page container">
        <div class="payment-tabs"><button class="tab-btn active" id="pay-tab-design" onclick="switchPaymentTab('design')">è¨­è¨ˆåˆç´„</button><button class="tab-btn" id="pay-tab-eng" onclick="switchPaymentTab('engineering')">å·¥ç¨‹åˆç´„</button></div>
        <div id="payment-content-container"></div>
    </div>

    <div id="project-detail-page" class="page container">
        <div id="advancement-alert">âš ï¸ æœ¬æ¡ˆæœ‰ä»£å¢Šæ¬¾é …å°šæœªçµæ¸…</div>

        <div class="detail-section">
            <div class="detail-title">åŸºæœ¬è³‡æ–™</div>
            <div class="input-row"><label class="input-label">æ¡ˆä»¶åç¨±</label><input type="text" class="detail-input" id="d-name" onchange="updateField('name', this.value)"></div>
            <div class="input-row-flex">
                <div style="flex:1"><label class="input-label">æ¥­ä¸»å§“å</label><input type="text" class="detail-input" id="d-client" onchange="updateField('client', this.value)"></div>
                <div style="flex:1"><label class="input-label">è¯çµ¡é›»è©±</label><input type="text" class="detail-input" id="d-phone" onchange="updateField('phone', this.value)"></div>
            </div>
            <div class="input-row"><label class="input-label">æ¡ˆä»¶åœ°å€</label><input type="text" class="detail-input" id="d-address" onchange="updateField('address', this.value)"></div>
            <div class="input-row-flex">
                <div style="flex:1"><label class="input-label">è»Šä½è™Ÿç¢¼</label><input type="text" class="detail-input" id="d-parking" onchange="updateField('parking', this.value)"></div>
                <div style="flex:1"><label class="input-label">å¤§é–€å¯†ç¢¼</label><input type="text" class="detail-input" id="d-code" onchange="updateField('code', this.value)"></div>
            </div>
            <div id="warranty-date-row" class="input-row" style="display:none; margin-top:15px;">
                <label class="input-label" style="color:var(--purple)">ä¿å›ºé–‹å§‹æ—¥æœŸ</label>
                <input type="date" class="detail-input" id="d-warranty-date" disabled>
            </div>
        </div>

        <!-- SOP åŸ·è¡Œå€å¡Š -->
        <div class="detail-section" style="border-left: 5px solid var(--orange);">
            <div class="detail-title" style="color:var(--orange)">
                SOP åŸ·è¡Œé€²åº¦
                <button class="btn-sop-action" style="margin:0;" onclick="openSyncSopModal()">åŒ¯å…¥ç¯„æœ¬</button>
            </div>
            <div id="project-sop-execution-container"></div>
            <button class="btn-sop-action" style="width:100%; margin-top:15px;" onclick="addLocalSopStage()">+ æ–°å¢è‡ªè¨‚éšæ®µæ¨™é¡Œ</button>
        </div>

        <!-- åŒ¯å…¥ SOP å½ˆçª— -->
        <div id="sync-sop-modal" class="modal-sync">
            <div class="sync-box">
                <h3 style="color:var(--orange); margin-top:0;">åŒ¯å…¥ SOP ç¯„æœ¬</h3>
                <p style="font-size:0.85rem; color:var(--text-secondary);">è«‹é¸æ“‡åŒ¯å…¥æ–¹å¼ï¼š</p>
                <button class="login-btn" style="background:var(--red); margin-bottom:20px;" onclick="importSopFromTemplate('all')">âš ï¸ å…¨éƒ¨è¦†è“‹åŒ¯å…¥</button>
                <hr style="border:0; border-top:1px solid var(--divider); margin-bottom:15px;">
                <p style="font-size:0.85rem; color:var(--text-secondary);">æˆ–æ˜¯é¸æ“‡ç‰¹å®šé …ç›®åŠ å…¥ï¼š</p>
                <div id="sync-sop-list"></div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="login-btn" style="flex:1; background:#555;" onclick="closeSyncSopModal()">å–æ¶ˆ</button>
                    <button class="login-btn" style="flex:1; background:var(--orange); color:#222;" onclick="importSopFromTemplate('selected')">åŠ å…¥å‹¾é¸é …ç›®</button>
                </div>
            </div>
        </div>

        <div class="detail-section" id="detail-payment-section">
            <div class="detail-title" style="color:var(--teal)">æ”¶æ¬¾é€²åº¦ & åˆç´„</div>
            <div id="design-price-row" class="input-row" style="display:none; margin-bottom:20px;">
                <label class="input-label">è¨­è¨ˆè²»ç¸½é¡</label>
                <input type="text" class="detail-input" id="d-design-price" placeholder="è¼¸å…¥é‡‘é¡" onfocus="toNum(this)" onkeyup="formatCurrency(this)" onchange="toCur(this); updateField('designPrice', this.value)">
                <div style="display:flex; align-items:center; margin-top:10px;">
                    <label class="toggle-switch"><input type="checkbox" id="d-design-tax-toggle" onchange="toggleDesignTax(this.checked)"><span class="slider"></span></label>
                    <span style="font-size:0.9rem; margin-left:10px;">ç¨…é‡‘ (5%)</span>
                    <span id="d-design-tax-val" style="margin-left:auto; color:#aaa;">$0</span>
                </div>
            </div>
            <div id="engineering-price-row" style="display:none; margin-bottom:20px;">
                <div class="input-row-flex">
                    <div style="flex:1"><label class="input-label">åˆç´„é‡‘é¡</label><input type="text" class="detail-input" id="d-eng-base" onfocus="toNum(this)" onkeyup="formatCurrency(this)" onchange="toCur(this); updateField('engBasePrice', this.value)"></div>
                    <div style="flex:1"><label class="input-label">è¿½åŠ æ¸›</label><input type="text" class="detail-input" id="d-eng-var" onfocus="toNum(this)" onkeyup="formatCurrency(this)" onchange="toCur(this); updateField('engVarPrice', this.value)"></div>
                </div>
                <div style="display:flex; align-items:center; margin-top:10px;">
                    <label class="toggle-switch"><input type="checkbox" id="d-eng-sup-toggle" onchange="toggleSupervision(this.checked)"><span class="slider"></span></label>
                    <span style="font-size:0.9rem; margin-left:10px;">ç›£å·¥è²»</span>
                    <select id="d-eng-sup-rate" class="stage-selector" style="width:80px; margin-left:10px; height:30px;" onchange="changeSupervisionRate(this.value)">
                        <option value="0.05">5%</option><option value="0.1">10%</option><option value="0.15">15%</option><option value="0.2">20%</option>
                    </select>
                    <span id="d-eng-sup-val" style="margin-left:auto; color:#aaa;">$0</span>
                </div>
                <div style="display:flex; align-items:center; margin-top:10px;">
                    <label class="toggle-switch"><input type="checkbox" id="d-eng-tax-toggle" onchange="toggleTax(this.checked)"><span class="slider"></span></label>
                    <span style="font-size:0.9rem; margin-left:10px;">ç¨…é‡‘ (5%)</span>
                    <span id="d-eng-tax-val" style="margin-left:auto; color:#aaa;">$0</span>
                </div>
                <div style="text-align:right; font-size:1.1rem; border-top:1px solid var(--divider); padding-top:10px; margin-top:10px;">ç¸½è¨ˆ: <span id="d-eng-total" style="color:var(--yellow);">$0</span></div>
            </div>
            <div id="detail-payment-container"></div>
            <button id="add-payment-btn" style="display:none; width:100%; margin-top:10px;" class="btn-sop-action" onclick="addEngineeringPaymentStage()">+ æ–°å¢æ”¶æ¬¾æœŸæ•¸</button>
        </div>

        <div class="detail-section">
            <div class="detail-title">æ–½å·¥éšæ®µé€²åº¦ <span id="progress-display" style="color:var(--teal); font-size:0.8rem;">0%</span><button class="btn-edit-mode" id="btn-edit-mode" onclick="toggleEditMode()">âš™ï¸ è¨­å®š</button></div>
            <div id="checklist-container"></div>
            <button id="btn-add-stage" class="btn-add-stage" style="display:none; width:100%;" onclick="addCustomStage()">+ è‡ªè¨‚é …ç›®</button>
        </div>

        <div class="detail-section">
            <div class="detail-title">æ¡ˆä»¶æ­·ç¨‹ & æ–½å·¥æ—¥èªŒ</div>
            <div class="log-input-area">
                <input type="date" id="new-log-date" class="detail-input">
                <textarea id="new-log-text" class="detail-input" rows="3" placeholder="ç´€éŒ„å…§å®¹..." style="margin-top:10px;"></textarea>
                <img id="new-log-preview" style="max-width:100px; display:none; margin-top:10px;">
                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <button class="btn-sop-action" onclick="document.getElementById('log-photo-upload').click()">ğŸ“· ç›¸ç‰‡</button>
                    <button class="login-btn" id="btn-save-log" style="width:auto; padding:0 20px;" onclick="addLog()">æ–°å¢ç´€éŒ„</button>
                </div>
                <input type="file" id="log-photo-upload" accept="image/*" style="display:none" onchange="handleTempPhoto(this)">
            </div>
            <div id="log-list-container"></div>
        </div>
        <div id="action-bar-container" class="action-bar"></div>
    </div>

    <div id="add-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">æ–°å¢æ¡ˆä»¶</h3>
            <input type="text" class="detail-input" id="new-name" placeholder="æ¡ˆä»¶åç¨±">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="login-btn" style="background:#555;" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button class="login-btn" onclick="createProject()">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDEKjRwWI6vkCg-dIsv1I4BamcC34UaJTU",
            authDomain: "te-interiorlab.firebaseapp.com",
            projectId: "te-interiorlab",
            storageBucket: "te-interiorlab.firebasestorage.app",
            messagingSenderId: "402097472858",
            appId: "1:402097472858:web:e21b7e698c848efa271f63",
            measurementId: "G-RLWZVP7R3Z"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(), storage = firebase.storage(), auth = firebase.auth();

        const STAGES_DESIGN_DEF = { 'ds1': 'ç¾å ´ä¸ˆé‡', 'ds2': 'å¹³é¢ææ¡ˆ', 'ds_sign': 'è¨­è¨ˆç°½ç´„', 'ds3': '3D ç¹ªè£½', 'ds4': 'æ–½å·¥åœ–', 'ds5': 'å·¥ç¨‹å ±åƒ¹', 'ds_eng_sign': 'å·¥ç¨‹ç°½ç´„' };
        const STAGES_ENG_DEF = { 'es_sign': 'å·¥ç¨‹ç°½ç´„', 'es1': 'é–‹å·¥æº–å‚™', 'es2': 'æ‹†é™¤å·¥ç¨‹', 'es3': 'éš”é–“å·¥ç¨‹', 'es4': 'æ°´é›»å·¥ç¨‹', 'es_ac': 'å†·æ°£å·¥ç¨‹', 'es5': 'æ³¥ä½œå·¥ç¨‹', 'es6': 'æœ¨ä½œå·¥ç¨‹', 'es7': 'ç³»çµ±æ«ƒå·¥ç¨‹', 'es_kitchen': 'å»šå…·å·¥ç¨‹', 'es8': 'æ²¹æ¼†å·¥ç¨‹', 'es9': 'ç‡ˆå…·å·¥ç¨‹', 'es10': 'éµä»¶å·¥ç¨‹', 'es_glass': 'ç»ç’ƒå·¥ç¨‹', 'es11': 'æœ¨åœ°æ¿å·¥ç¨‹', 'es12': 'æ¸…æ½”å·¥ç¨‹', 'es13': 'è»Ÿè£å·¥ç¨‹', 'es14': 'æ”¶å°¾å·¥ç¨‹' };
        const DEFAULT_DESIGN_ORDER = ['ds1', 'ds2', 'ds_sign', 'ds3', 'ds4', 'ds5', 'ds_eng_sign'];
        const DEFAULT_ENG_ORDER = ['es_sign', 'es1', 'es2', 'es3', 'es4', 'es_ac', 'es5', 'es6', 'es7', 'es_kitchen', 'es8', 'es9', 'es10', 'es_glass', 'es11', 'es12', 'es13', 'es14'];

        let designProjects = [], engProjects = [], sopTemplates = { design: [], engineering: [] };
        let currentType = '', currentId = '', calDate = new Date(), addModeType = '', currentSopTplType = 'design', currentPaymentTab = 'design';
        let isEditMode = false, editingLogId = null, tempPhotoFile = null;

        function safe(str) { return !str ? '' : String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

        window.onload = () => {
            document.getElementById('loading-overlay').style.display = 'flex';
            auth.onAuthStateChanged(user => {
                if (user) {
                    initFirestoreListeners();
                    document.getElementById('login-overlay').style.display = 'none';
                } else {
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('login-overlay').style.display = 'flex';
                }
            });
        };

        function initFirestoreListeners() {
            db.collection("settings").doc("sop_templates").onSnapshot(doc => { if (doc.exists) sopTemplates = doc.data(); });
            db.collection("design_projects").onSnapshot(snap => { designProjects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); refreshUI(); });
            db.collection("eng_projects").onSnapshot(snap => { engProjects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); refreshUI(); document.getElementById('loading-overlay').style.display = 'none'; });
        }

        function refreshUI() {
            renderHomeCounts();
            const activePage = document.querySelector('.page.active').id;
            if(activePage === 'home-page') { renderCalendar(); checkAlerts(); }
            else if(activePage === 'design-list-page') renderList('design');
            else if(activePage === 'engineering-list-page') renderList('engineering');
            else if(activePage === 'warranty-list-page') renderList('warranty');
            else if(activePage === 'payment-page') renderPaymentPage();
            else if(activePage === 'sop-tpl-page') renderSopTplEditor();
        }

        function renderHomeCounts() {
            document.getElementById('cnt-design').innerText = designProjects.filter(p=>p.status!=='completed').length;
            document.getElementById('cnt-eng').innerText = engProjects.filter(p=>['active','suspended'].includes(p.status)).length;
            document.getElementById('cnt-warranty').innerText = engProjects.filter(p=>p.status==='warranty').length;
        }

        // --- SOP ç¯„æœ¬ç®¡ç† ---
        function switchSopTpl(type) {
            currentSopTplType = type;
            document.querySelectorAll('.sop-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('sop-tab-' + (type === 'design' ? 'design' : 'eng')).classList.add('active');
            renderSopTplEditor();
        }
        function renderSopTplEditor() {
            const container = document.getElementById('sop-tpl-editor-container'); container.innerHTML = '';
            (sopTemplates[currentSopTplType] || []).forEach((h, hIdx) => {
                const div = document.createElement('div');
                div.innerHTML = `<div style="display:flex; gap:10px; margin-top:15px;"><input type="text" class="detail-input" style="font-weight:bold; border-color:var(--orange);" value="${h.title}" onchange="updateSopTplTitle(${hIdx},this.value)"><button class="btn-mini-del" onclick="deleteSopTplHeader(${hIdx})">âœ•</button></div><div id="tpl-items-${hIdx}"></div><button class="btn-sop-action" style="margin-left:20px;" onclick="addSopTplItem(${hIdx})">+ æ–°å¢é …ç›®</button>`;
                container.appendChild(div);
                h.items.forEach((item, iIdx) => {
                    document.getElementById(`tpl-items-${hIdx}`).innerHTML += `<div style="display:flex; gap:10px; margin:5px 0 5px 20px;"><input type="text" class="detail-input" style="font-size:0.9rem; padding:8px;" value="${item.text}" onchange="updateSopTplItem(${hIdx},${iIdx},this.value)"><button class="btn-mini-del" onclick="deleteSopTplItem(${hIdx},${iIdx})">âœ•</button></div>`;
                });
            });
        }
        async function saveSopTpl() { await db.collection("settings").doc("sop_templates").set(sopTemplates); }
        function addSopTplHeader() { sopTemplates[currentSopTplType].push({title:'æ–°éšæ®µ', items:[]}); saveSopTpl(); renderSopTplEditor(); }
        function updateSopTplTitle(idx,v) { sopTemplates[currentSopTplType][idx].title = v; saveSopTpl(); }
        function deleteSopTplHeader(idx) { if(confirm('åˆªé™¤æ¨™é¡Œï¼Ÿ')){ sopTemplates[currentSopTplType].splice(idx,1); saveSopTpl(); renderSopTplEditor(); }}
        function addSopTplItem(idx) { sopTemplates[currentSopTplType][idx].items.push({text:'æ–°é …ç›®', done:false, date:''}); saveSopTpl(); renderSopTplEditor(); }
        function updateSopTplItem(h,i,v) { sopTemplates[currentSopTplType][h].items[i].text = v; saveSopTpl(); }
        function deleteSopTplItem(h,i) { sopTemplates[currentSopTplType][h].items.splice(i,1); saveSopTpl(); renderSopTplEditor(); }

        // --- SOP è©³æƒ…å…§ç·¨è¼¯èˆ‡åŒ¯å…¥ ---
        function renderProjectSopExecution(p) {
            const container = document.getElementById('project-sop-execution-container'); container.innerHTML = '';
            (p.sopData || []).forEach((h, hIdx) => {
                const head = document.createElement('div'); head.className = 'sop-header collapsed'; head.innerHTML = `<span>${safe(h.title)}</span> <button class="btn-mini-del" onclick="deleteLocalSopStage(${hIdx}); event.stopPropagation();">âœ•</button>`;
                head.onclick = function(e){ if(e.target.tagName!=='BUTTON'){ this.classList.toggle('collapsed'); this.nextElementSibling.classList.toggle('hidden'); }};
                const content = document.createElement('div'); content.className = 'sop-content hidden';
                h.items.forEach((item, iIdx) => {
                    content.innerHTML += `<div class="sop-item-row"><div class="custom-checkbox ${item.done?'checked':''}" onclick="toggleSopItem(${hIdx},${iIdx})"></div><input type="text" class="sop-text" style="background:none; border:none; color:white;" value="${safe(item.text)}" onchange="updateLocalSopItem(${hIdx},${iIdx},this.value)"><input type="date" class="sop-date-input" value="${item.date||''}" onchange="updateSopDate(${hIdx},${iIdx},this.value)"><button class="btn-mini-del" onclick="deleteLocalSopItem(${hIdx},${iIdx})">âœ•</button></div>`;
                });
                content.innerHTML += `<button class="btn-sop-action" style="margin:10px 0 10px 35px;" onclick="addLocalSopItem(${hIdx})">+ æ–°å¢é …ç›®</button>`;
                container.appendChild(head); container.appendChild(content);
            });
        }
        function openSyncSopModal() {
            document.getElementById('sync-sop-modal').style.display='flex';
            const list = document.getElementById('sync-sop-list'); list.innerHTML = '';
            (sopTemplates[currentType] || []).forEach((h, hIdx) => {
                list.innerHTML += `<div style="font-weight:bold; color:var(--orange); margin-top:10px;">${h.title}</div>`;
                h.items.forEach((item, iIdx) => {
                    list.innerHTML += `<label class="sync-item"><input type="checkbox" class="sync-check" data-h="${hIdx}" data-i="${iIdx}"> ${item.text}</label>`;
                });
            });
        }
        function closeSyncSopModal() { document.getElementById('sync-sop-modal').style.display='none'; }
        async function importSopFromTemplate(mode) {
            const p = getActiveProject(); const tpl = sopTemplates[currentType] || [];
            if(mode==='all'){ if(!confirm('é€™å°‡è¦†è“‹ç¾æœ‰æ‰€æœ‰ SOP é€²åº¦ï¼Œç¢ºå®šï¼Ÿ')) return; p.sopData = JSON.parse(JSON.stringify(tpl)); }
            else {
                const checks = document.querySelectorAll('.sync-check:checked');
                if(!checks.length) return alert('æœªå‹¾é¸é …ç›®');
                checks.forEach(chk => {
                    const h = chk.dataset.h, i = chk.dataset.i;
                    const tHeader = tpl[h];
                    let pHeader = p.sopData.find(x => x.title === tHeader.title);
                    if(!pHeader) { pHeader = {title:tHeader.title, items:[]}; p.sopData.push(pHeader); }
                    pHeader.items.push(JSON.parse(JSON.stringify(tHeader.items[i])));
                });
            }
            await updateActiveSop(p.sopData); renderProjectSopExecution(p); closeSyncSopModal();
        }

        async function toggleSopItem(h,i) {
            const p = getActiveProject(); p.sopData[h].items[i].done = !p.sopData[h].items[i].done;
            if(p.sopData[h].items[i].done && !p.sopData[h].items[i].date) p.sopData[h].items[i].date = new Date().toISOString().split('T')[0];
            await updateActiveSop(p.sopData); renderProjectSopExecution(p);
        }
        async function updateSopDate(h,i,v) { const p = getActiveProject(); p.sopData[h].items[i].date = v; await updateActiveSop(p.sopData); }
        async function updateLocalSopItem(h,i,v) { const p = getActiveProject(); p.sopData[h].items[i].text = v; await updateActiveSop(p.sopData); }
        async function addLocalSopItem(h) { const p = getActiveProject(); p.sopData[h].items.push({text:'æ–°é …ç›®',done:false,date:''}); await updateActiveSop(p.sopData); renderProjectSopExecution(p); }
        async function deleteLocalSopItem(h,i) { if(confirm('åˆªé™¤é …ç›®ï¼Ÿ')){ const p = getActiveProject(); p.sopData[h].items.splice(i,1); await updateActiveSop(p.sopData); renderProjectSopExecution(p); }}
        async function addLocalSopStage() { const p = getActiveProject(); p.sopData.push({title:'æ–°éšæ®µ', items:[]}); await updateActiveSop(p.sopData); renderProjectSopExecution(p); }
        async function deleteLocalSopStage(h) { if(confirm('åˆªé™¤æ•´å€‹éšæ®µï¼Ÿ')){ const p = getActiveProject(); p.sopData.splice(h,1); await updateActiveSop(p.sopData); renderProjectSopExecution(p); }}

        // --- æ ¸å¿ƒæ¢å¾© ---
        function navigateTo(id) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.getElementById('back-btn').style.display = (id==='home-page'?'none':'block'); refreshUI(); }
        function goBack() { navigateTo('home-page'); }
        function logout() { auth.signOut().then(()=>location.reload()); }
        function performLogin() { auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err=>alert(err.message)); }

        function renderCalendar() {
            const y = calDate.getFullYear(), m = calDate.getMonth();
            document.getElementById('cal-month-year').innerText = `${y} / ${String(m+1).padStart(2,'0')}`;
            const c = document.getElementById('calendar-days'); c.innerHTML = '';
            for(let i=0; i<new Date(y,m,1).getDay(); i++) c.innerHTML += '<div></div>';
            for(let d=1; d<=new Date(y,m+1,0).getDate(); d++){
                const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let hD = false, hE = false;
                designProjects.forEach(p=>{ Object.values(p.stages||{}).forEach(s=>{ if(s.start&&s.end&&ds>=s.start&&ds<=s.end) hD=true; }); });
                engProjects.forEach(p=>{ if(p.status!=='warranty') Object.values(p.stages||{}).forEach(s=>{ if(s.enabled!==false&&s.start&&s.end&&ds>=s.start&&ds<=s.end) hE=true; }); });
                const bars = `<div class="cal-bar-container">${hD?'<div class="cal-bar bar-design"></div>':''}${hE?'<div class="cal-bar bar-eng"></div>':''}</div>`;
                const div = document.createElement('div'); div.className = 'cal-date'; div.innerHTML = `<span>${d}</span>${bars}`;
                div.onclick = () => showEvents(ds, div); c.appendChild(div);
            }
        }
        function showEvents(ds, el) {
            document.querySelectorAll('.cal-date').forEach(e=>e.classList.remove('active')); el.classList.add('active');
            const b = document.getElementById('calendar-events'); b.innerHTML = `<b>ğŸ“… ${ds}</b>`;
            const addEv = (list, type) => list.forEach(p => {
                Object.keys(p.stages||{}).forEach(sid => {
                    const s = p.stages[sid];
                    if(s.enabled!==false && s.start && s.end && ds>=s.start && ds<=s.end) {
                        b.innerHTML += `<div class="event-item" onclick="openDetail('${type}','${p.id}')"><div class="dot" style="background:var(--${type==='design'?'blue':'yellow'})"></div>${p.name} - ${s.name||(type==='design'?STAGES_DESIGN_DEF[sid]:STAGES_ENG_DEF[sid])}</div>`;
                    }
                });
            });
            addEv(designProjects, 'design'); addEv(engProjects, 'engineering');
        }

        function renderList(type) {
            const container = document.getElementById(type==='warranty'?'warranty-list-container':(type==='design'?'design-list-container':'engineering-list-container'));
            container.innerHTML = '';
            let list = type === 'design' ? designProjects : (type === 'engineering' ? engProjects.filter(p=>['active','suspended'].includes(p.status)) : engProjects.filter(p=>p.status==='warranty'));
            list.forEach(p => {
                const prog = calculateProgress(p, type==='design'?'design':'engineering');
                const pct = prog.activeCount===0?0:Math.round((prog.doneCount/prog.activeCount)*100);
                container.innerHTML += `<div class="project-card" onclick="openDetail('${type==='warranty'?'engineering':(type==='design'?'design':'engineering')}','${p.id}')">
                    <div style="font-weight:bold;">${safe(p.name)} ${p.status==='suspended'?'<span class="tag tag-suspend">æš«ç·©</span>':''}</div>
                    <div style="font-size:0.85rem; color:#888;">${safe(p.client)}</div>
                    <div class="progress-bg"><div class="progress-fill" style="width:${pct}%"></div></div>
                </div>`;
            });
        }

        function openDetail(type, id) {
            currentType = type; currentId = id; isEditMode = false;
            const p = (type==='design'?designProjects:engProjects).find(x=>x.id===id);
            ['name','client','phone','address','parking','code'].forEach(k=>document.getElementById('d-'+k).value = p[k]||'');
            document.getElementById('design-price-row').style.display = type==='design'?'block':'none';
            document.getElementById('engineering-price-row').style.display = type==='engineering'?'block':'none';
            document.getElementById('add-payment-btn').style.display = type==='engineering'?'block':'none';
            if(type==='design'){ document.getElementById('d-design-price').value = formatNumber(p.designPrice); document.getElementById('d-design-tax-toggle').checked = !!p.taxEnabled; calculateTotalDesign(p); }
            else { 
                document.getElementById('d-eng-base').value = formatNumber(p.engBasePrice); document.getElementById('d-eng-var').value = formatNumber(p.engVarPrice); 
                document.getElementById('d-eng-tax-toggle').checked = !!p.taxEnabled; document.getElementById('d-eng-sup-toggle').checked = !!p.supervisionEnabled;
                document.getElementById('d-eng-sup-rate').value = p.supervisionRate || "0.05"; calculateTotalEng(p);
            }
            renderProjectSopExecution(p); renderDetailPayments(p, type); renderStages(p, type); renderLogs(p); renderActionBar(type, p.status);
            navigateTo('project-detail-page');
        }

        function renderStages(p, type) {
            const container = document.getElementById('checklist-container'); container.innerHTML = '';
            const order = p.stageOrder || (type==='design'?DEFAULT_DESIGN_ORDER:DEFAULT_ENG_ORDER);
            order.forEach(sid => {
                const s = p.stages[sid] || {done:false, enabled:true};
                if(!isEditMode && s.enabled === false) return;
                const div = document.createElement('div'); div.className = `checklist-item ${s.done?'checked':''}`;
                let h = `<div class="check-header">`;
                if(isEditMode) h += `<label class="toggle-switch"><input type="checkbox" ${s.enabled!==false?'checked':''} onchange="toggleStageEnable('${sid}',this.checked)"><span class="slider"></span></label>`;
                h += `<div style="flex:1; display:flex; align-items:center" onclick="if(!isEditMode)toggleDoneOptimistic('${sid}')"><div class="custom-checkbox"></div><b>${safe(s.name||(type==='design'?STAGES_DESIGN_DEF[sid]:STAGES_ENG_DEF[sid]))}</b></div></div>`;
                if(s.enabled!==false){
                    let d = `<div class="stage-details">`;
                    if(type!=='design') d += `<div class="input-row-flex"><input type="text" class="detail-input" style="padding:8px;" placeholder="å» å•†" value="${safe(s.vendor)}" onchange="updateStageField('${sid}','vendor',this.value)"><input type="text" class="detail-input" style="padding:8px; color:var(--orange);" placeholder="æˆæœ¬" value="${formatNumber(s.cost)}" onfocus="toNum(this)" onchange="toCur(this); updateStageField('${sid}','cost',this.value)"></div>`;
                    d += `<div class="date-row"><div class="date-group"><input type="date" class="mini-date" value="${s.start}" onchange="updateStageField('${sid}','start',this.value)"></div><div class="date-group"><input type="date" class="mini-date" value="${s.end}" onchange="updateStageField('${sid}','end',this.value)"></div></div></div>`;
                    div.innerHTML = h + d;
                } else div.innerHTML = h;
                container.appendChild(div);
            });
            const prog = calculateProgress(p, type); document.getElementById('progress-display').innerText = Math.round((prog.doneCount/prog.activeCount)*100) + '%';
        }

        // --- æ ¸å¿ƒåŠŸèƒ½è¼”åŠ© ---
        function getActiveProject() { return (currentType==='design'?designProjects:engProjects).find(x=>x.id===currentId); }
        async function updateActiveSop(data) { await db.collection(currentType==='design'?"design_projects":"eng_projects").doc(currentId).update({sopData: data}); }
        async function updateField(k,v) { let val = v; if(['designPrice','engBasePrice','engVarPrice'].includes(k)) val = parseCurrency(v); await db.collection(currentType==='design'?"design_projects":"eng_projects").doc(currentId).update({[k]: val}); }
        async function updateStageField(sid, f, v) { let val = (f==='cost')?parseCurrency(v):v; await db.collection(currentType==='design'?"design_projects":"eng_projects").doc(currentId).update({[`stages.${sid}.${f}`]: val}); }
        function calculateProgress(p, type) { let active = 0, done = 0; const order = p.stageOrder || (type==='design'?DEFAULT_DESIGN_ORDER:DEFAULT_ENG_ORDER); order.forEach(sid => { const s = p.stages[sid]; if(s && s.enabled!==false){ active++; if(s.done) done++; } else if(!s && type==='design'){ active++; } }); return { activeCount: active||1, doneCount: done }; }
        function formatNumber(n) { return !n ? '' : n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
        function parseCurrency(s) { return parseInt(s.toString().replace(/,/g, '')) || 0; }
        function toNum(el) { el.value = el.value.replace(/,/g, ''); }
        function toCur(el) { el.value = formatNumber(el.value); }
        function calculateTotalDesign(p) { let pr = parseInt(p.designPrice)||0, tx = p.taxEnabled?Math.round(pr*0.05):0; document.getElementById('d-design-tax-val').innerText = '$'+formatNumber(tx); return pr+tx; }
        function calculateTotalEng(p) { let b = parseInt(p.engBasePrice)||0, v = parseInt(p.engVarPrice)||0, sum = b+v; let sp = p.supervisionEnabled?Math.round(sum*(p.supervisionRate||0.05)):0; let tx = p.taxEnabled?Math.round((sum+sp)*0.05):0; document.getElementById('d-eng-sup-val').innerText = '$'+formatNumber(sp); document.getElementById('d-eng-tax-val').innerText = '$'+formatNumber(tx); document.getElementById('d-eng-total').innerText = '$'+formatNumber(sum+sp+tx); return sum+sp+tx; }
        async function toggleDesignTax(e){ await updateField('taxEnabled', e); openDetail(currentType, currentId); }
        async function toggleTax(e){ await updateField('taxEnabled', e); openDetail(currentType, currentId); }
        async function toggleSupervision(e){ await updateField('supervisionEnabled', e); openDetail(currentType, currentId); }
        async function changeSupervisionRate(v){ await updateField('supervisionRate', parseFloat(v)); openDetail(currentType, currentId); }

        function renderPaymentPage() {
            const container = document.getElementById('payment-content-container'); container.innerHTML = '';
            const list = currentPaymentTab === 'design' ? designProjects : engProjects;
            const groups = { pending: [], done: [] };
            list.forEach(p => { const isD = p.manualPaymentDone !== undefined ? p.manualPaymentDone : (p.payments?.length > 0 && p.payments.every(pay => pay.done)); groups[isD ? 'done' : 'pending'].push(p); });
            const rendGroup = (arr, tit, hide) => {
                let h = `<div class="pay-accordion-header ${hide?'collapsed':''}" onclick="this.classList.toggle('collapsed'); this.nextElementSibling.classList.toggle('hidden')">${tit} (${arr.length})</div><div class="pay-accordion-content ${hide?'hidden':''}">`;
                arr.forEach(p => {
                    let total = currentPaymentTab==='design'?calculateTotalDesign(p):calculateTotalEng(p);
                    h += `<div class="payment-card"><div style="display:flex; justify-content:space-between;"><b>${p.name}</b><button class="btn-sop-action" onclick="toggleManualPay('${p.id}')">${p.manualPaymentDone?'ç§»å›æœªæ”¶':'ç§»å…¥å·²æ”¶'}</button></div><div style="color:var(--yellow); font-size:0.9rem; margin-bottom:10px;">ç¸½é¡: $${formatNumber(total)}</div>`;
                    (p.payments || []).forEach(pay => { let amt = currentPaymentTab==='design'?Math.round(total*pay.ratio):pay.amount; h += `<div style="display:flex; align-items:center; gap:10px; font-size:0.85rem; padding:5px 0; border-top:1px solid #444;"><div class="custom-checkbox ${pay.done?'checked':''}"></div><div style="flex:1;">${pay.name}</div><div style="color:var(--yellow);">$${formatNumber(amt)}</div><div style="width:100px; text-align:right;">${pay.date||''}</div></div>`; });
                    h += `</div>`;
                });
                container.innerHTML += h + `</div>`;
            };
            rendGroup(groups.pending, 'æœªæ”¶æ¬¾å®Œç•¢', false); rendGroup(groups.done, 'å·²æ”¶æ¬¾å®Œç•¢', true);
        }
        async function toggleManualPay(pid){ const p = (currentPaymentTab==='design'?designProjects:engProjects).find(x=>x.id===pid); await db.collection(currentPaymentTab==='design'?"design_projects":"eng_projects").doc(pid).update({manualPaymentDone: !p.manualPaymentDone}); }
        function switchPaymentTab(t){ currentPaymentTab=t; document.getElementById('pay-tab-design').classList.toggle('active', t==='design'); document.getElementById('pay-tab-eng').classList.toggle('active', t==='engineering'); renderPaymentPage(); }

        function renderDetailPayments(p, type) {
            const container = document.getElementById('detail-payment-container'); container.innerHTML = '';
            const total = type==='design'?calculateTotalDesign(p):calculateTotalEng(p);
            (p.payments || []).forEach((pay, idx) => {
                let amt = type==='design'?`$${formatNumber(Math.round(total*pay.ratio))}`:`<input type="text" class="pay-amount-input" value="${formatNumber(pay.amount)}" onfocus="toNum(this)" onchange="toCur(this); updatePaymentField(${idx},'amount',this.value)">`;
                let sel = ''; if(type!=='design'){
                    let opts = '<option value="">-- å°æ‡‰éšæ®µ --</option>'; 
                    (p.stageOrder||DEFAULT_ENG_ORDER).forEach(sid=>{ if(p.stages[sid]?.enabled!==false) opts+=`<option value="${sid}" ${pay.linkedStage===sid?'selected':''}>${safe(p.stages[sid]?.name||STAGES_ENG_DEF[sid])}</option>`; });
                    sel = `<select class="stage-selector" onchange="updatePaymentField(${idx},'linkedStage',this.value)">${opts}</select>`;
                }
                container.innerHTML += `<div class="payment-row"><div class="pay-col-check"><div class="custom-checkbox ${pay.done?'checked':''}" onclick="togglePayment(${idx})"></div></div><div class="pay-col-name"><input type="text" class="pay-name-input" value="${pay.name}" onchange="updatePaymentField(${idx},'name',this.value)">${sel}</div><div class="pay-col-info"><div style="display:flex; align-items:center; gap:5px; color:var(--yellow);">${amt}<button class="btn-mini-del" onclick="deletePayment(${idx})">Ã—</button></div><input type="date" class="pay-date-input" value="${pay.date||''}" onchange="updatePaymentField(${idx},'date',this.value)"></div></div>`;
            });
        }
        async function updatePaymentField(idx, f, v){ const p = getActiveProject(); p.payments[idx][f] = (f==='amount')?parseCurrency(v):v; await updateField('payments', p.payments); openDetail(currentType,currentId); }
        async function togglePayment(idx){ const p = getActiveProject(); p.payments[idx].done = !p.payments[idx].done; if(p.payments[idx].done && !p.payments[idx].date) p.payments[idx].date = new Date().toISOString().split('T')[0]; await updateField('payments', p.payments); openDetail(currentType,currentId); }
        async function deletePayment(idx){ if(confirm('åˆªé™¤æœŸæ•¸ï¼Ÿ')){ const p = getActiveProject(); p.payments.splice(idx,1); await updateField('payments', p.payments); openDetail(currentType,currentId); }}
        async function addEngineeringPaymentStage(){ const p = getActiveProject(); if(!p.payments) p.payments = []; p.payments.push({name:`ç¬¬ ${p.payments.length+1} æœŸ`, amount:0, done:false, date:''}); await updateField('payments', p.payments); openDetail(currentType,currentId); }

        function renderActionBar(type, status) {
            const b = document.getElementById('action-bar-container'); b.innerHTML = '';
            if(type==='design') b.innerHTML = `<button class="action-btn" style="background:var(--yellow);" onclick="updateStatus('tracking')">${status==='tracking'?'å–æ¶ˆè¿½è¹¤':'è¿½è¹¤ä¸­'}</button><button class="action-btn" style="background:var(--red); color:white;" onclick="deleteProj()">åˆªé™¤</button><button class="action-btn" style="background:var(--green);" onclick="convertToEng()">å®Œæˆè½‰å·¥ç¨‹</button>`;
            else b.innerHTML = `<button class="action-btn" style="background:var(--red); color:white;" onclick="deleteProj()">åˆªé™¤</button><button class="action-btn" style="background:var(--orange);" onclick="updateStatus('suspended')">${status==='suspended'?'æ¢å¾©':'æš«ç·©'}</button><button class="action-btn" style="background:var(--green);" onclick="updateStatus('warranty')">å®Œå·¥çµæ¡ˆ</button>`;
        }
        async function updateStatus(s){
            const p = getActiveProject(); let nS = s;
            if(s==='tracking') nS = p.status==='tracking'?'active':'tracking';
            if(s==='suspended') nS = p.status==='suspended'?'active':'suspended';
            if(s==='warranty'){ if(!confirm('ç¢ºèªçµæ¡ˆï¼Ÿ'))return; await db.collection("eng_projects").doc(currentId).update({status:'warranty', warrantyDate:new Date().toISOString().split('T')[0]}); goBack(); return; }
            await db.collection(currentType==='design'?"design_projects":"eng_projects").doc(currentId).update({status:nS}); goBack();
        }
        async function deleteProj(){ if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){ await db.collection(currentType==='design'?"design_projects":"eng_projects").doc(currentId).delete(); goBack(); }}

        function handleTempPhoto(i){ if(i.files[0]){ tempPhotoFile=i.files[0]; const r=new FileReader(); r.onload=e=>{document.getElementById('new-log-preview').src=e.target.result; document.getElementById('new-log-preview').style.display='block';}; r.readAsDataURL(i.files[0]); }}
        async function addLog() {
            const d = document.getElementById('new-log-date').value, t = document.getElementById('new-log-text').value;
            if(!d) return alert('è«‹é¸æ“‡æ—¥æœŸ'); document.getElementById('loading-overlay').style.display='flex';
            let url = ''; if(tempPhotoFile){ const ref = storage.ref().child(`logs/${Date.now()}`); await ref.put(tempPhotoFile); url = await ref.getDownloadURL(); }
            const p = getActiveProject(); p.logs.push({id:Date.now(), date:d, content:t, photo:url});
            await updateField('logs', p.logs); document.getElementById('loading-overlay').style.display='none'; openDetail(currentType, currentId);
        }
        function renderLogs(p){
            const c = document.getElementById('log-list-container'); c.innerHTML = '';
            (p.logs||[]).sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(l => {
                c.innerHTML += `<div class="log-item"><button class="log-delete" onclick="deleteLog(${l.id})">Ã—</button><div style="color:var(--blue); font-size:0.8rem; font-weight:bold;">${l.date}</div><div style="margin-top:5px; white-space:pre-wrap;">${safe(l.content)}</div>${l.photo?`<img src="${l.photo}" class="log-image">`:''}</div>`;
            });
        }
        async function deleteLog(id){ if(confirm('åˆªé™¤æ—¥èªŒï¼Ÿ')){ const p = getActiveProject(); p.logs = p.logs.filter(x=>x.id!==id); await updateField('logs', p.logs); openDetail(currentType, currentId); }}

        function checkAlerts(){ 
            const l = document.getElementById('alert-list'); l.innerHTML = ''; const t = new Date().toISOString().split('T')[0]; let h = false;
            const chk = (pr, lbl) => pr.forEach(p => { if(p.status!=='suspended' && p.status!=='warranty') Object.values(p.stages||{}).forEach(s => { if(s.enabled!==false && s.end && s.end < t && !s.done){ h=true; l.innerHTML += `<div class="alert-item" onclick="openDetail('${lbl==='è¨­'?'design':'engineering'}','${p.id}')">âš ï¸ [${lbl}] ${p.name} å»¶èª¤</div>`; }}); });
            chk(designProjects,'è¨­'); chk(engProjects,'å·¥');
            document.getElementById('alert-dashboard').style.display = h ? 'block' : 'none';
        }
        function openAddModal(t){ addModeType=t; document.getElementById('add-modal').style.display='flex'; }
        function closeAddModal(){ document.getElementById('add-modal').style.display='none'; }
        async function createProject() {
            const n = document.getElementById('new-name').value; if(!n)return;
            const col = addModeType==='design'?"design_projects":"eng_projects";
            const obj = { name:n, status:'active', logs:[], stages:{}, payments:[], sopData:JSON.parse(JSON.stringify(sopTemplates[addModeType]||[])), createdAt:firebase.firestore.FieldValue.serverTimestamp() };
            if(addModeType==='design'){ obj.stageOrder = DEFAULT_DESIGN_ORDER; obj.payments = [{name:'ç°½ç´„é‡‘(50%)',ratio:0.5,done:false},{name:'å°¾æ¬¾(50%)',ratio:0.5,done:false}]; }
            else obj.stageOrder = DEFAULT_ENG_ORDER;
            const doc = await db.collection(col).add(obj); closeAddModal(); openDetail(addModeType, doc.id);
        }
        function changeMonth(n){ calDate.setMonth(calDate.getMonth()+n); renderCalendar(); }
        function toggleEditMode(){ isEditMode=!isEditMode; document.getElementById('btn-edit-mode').classList.toggle('active'); document.getElementById('btn-add-stage').style.display=isEditMode?'block':'none'; renderStages(getActiveProject(), currentType); }
        function toggleStageEnable(sid,v){ const p = getActiveProject(); if(!p.stages[sid]) p.stages[sid]={done:false,enabled:true}; p.stages[sid].enabled = v; updateStageField(sid,'enabled',v); }
        function toggleDoneOptimistic(sid){ const p = getActiveProject(); if(!p.stages[sid]) p.stages[sid]={done:false,enabled:true}; p.stages[sid].done = !p.stages[sid].done; updateStageField(sid,'done',p.stages[sid].done); renderStages(p, currentType); }
    </script>
</body>
</html>
