<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â∞çÈåØÁ©∫Èñì v26.0 (SOP Template & Auto-Creation)</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#202124">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        :root { --bg-color: #202124; --surface-color: #303134; --text-primary: #e8eaed; --text-secondary: #9aa0a6; --divider: #3c4043; --blue: #8ab4f8; --red: #f28b82; --green: #81c995; --yellow: #fdd663; --orange: #fcad70; --purple: #c58af9; --teal: #64ffda; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-primary); -webkit-tap-highlight-color: transparent; padding-bottom: 90px; overscroll-behavior-y: none; }
        button, input, textarea, select { font-family: inherit; }
        header { background-color: var(--surface-color); padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--divider); display: flex; align-items: center; justify-content: center; }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 500; }
        .header-back { position: absolute; left: 15px; background: none; border: none; font-size: 1rem; color: var(--blue); cursor: pointer; display: none; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .page { display: none; } .page.active { display: block; }
        
        /* Overlays */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; color:white; font-size:1.2rem; flex-direction: column; gap:10px; text-align: center; padding: 20px;}
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .login-box { background: var(--surface-color); padding: 30px; border-radius: 12px; width: 100%; max-width: 320px; text-align: center; border: 1px solid var(--divider); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(0,0,0,0.2); border: 1px solid var(--divider); color: var(--text-primary); border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .login-btn { width: 100%; padding: 12px; background: var(--blue); color: #202124; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        
        /* UI Elements */
        .calendar-section { background: var(--surface-color); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-day-name { color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 5px; }
        .cal-date { border-radius: 6px; font-size: 0.85rem; cursor: pointer; position: relative; height: 48px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 4px; background: rgba(255,255,255,0.02); }
        .cal-date.active { background-color: rgba(138, 180, 248, 0.2); color: var(--blue); font-weight: bold; border: 1px solid var(--blue); }
        .event-list-box { margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--divider); font-size: 0.9rem; color: var(--text-secondary); min-height: 20px;}
        .event-item { margin-bottom: 8px; display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; cursor: pointer; background: rgba(255,255,255,0.03); }
        .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

        .alert-section { background-color: rgba(242, 139, 130, 0.15); border: 1px solid var(--red); border-radius: 12px; padding: 15px; margin-bottom: 20px; display: none; }
        .alert-item { color: var(--red); font-size: 0.9rem; margin-bottom: 8px; cursor: pointer; padding-bottom: 5px; border-bottom: 1px solid rgba(242, 139, 130, 0.3); }
        .project-card { background: var(--surface-color); border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid var(--divider); position: relative; overflow: hidden; cursor: pointer; z-index: 1; }
        .progress-bg { position: absolute; bottom: 0; left: 0; height: 4px; width: 100%; background: #444; z-index: 0; }
        .progress-fill { height: 100%; transition: width 0.3s; background: linear-gradient(to right, var(--green), var(--yellow)); }
        .tag { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
        .tag-track { background: var(--yellow); color: #333; } .tag-done { background: var(--green); color: #333; } .tag-suspend { background: var(--red); color: white; } .tag-warranty { background: var(--purple); color: white; }
        .card-progress-text { font-size: 0.85rem; color: var(--teal); margin-top: 5px; display: flex; align-items: center; gap: 5px; } .card-progress-text::before { content: '‚ñ∫'; font-size: 0.7rem; }

        .detail-section { background: var(--surface-color); padding: 20px; border-radius: 12px; margin-bottom: 15px; }
        .detail-title { font-size: 0.9rem; font-weight: bold; color: var(--blue); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;}
        .input-row { margin-bottom: 15px; } .input-label { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px; display: block; }
        .detail-input { width: 100%; padding: 12px; box-sizing: border-box; background: #202124; border: 1px solid var(--divider); border-radius: 8px; font-size: 1rem; color: var(--text-primary); }

        .custom-checkbox { width: 22px; height: 22px; border: 2px solid var(--text-secondary); border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; flex-shrink: 0; transition: background 0.1s; cursor: pointer; color: transparent; font-weight: bold; }
        .custom-checkbox.checked { background: var(--green); border-color: var(--green) !important; color: #202124; }
        .custom-checkbox.checked::after { content: '‚úì'; }

        .mini-date, .pay-date-input { width: 100%; background: #202124; border: 1px solid var(--divider); color: var(--text-primary); padding: 6px 4px; border-radius: 6px; font-size: 0.8rem; color-scheme: dark; white-space: nowrap; overflow: hidden; }

        /* SOP Styles */
        .sop-section-header { background: #3c4043; padding: 10px 15px; border-radius: 8px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .sop-section-header::after { content: '‚ñº'; font-size: 0.7rem; transition: transform 0.3s; }
        .sop-section-header.collapsed::after { transform: rotate(-90deg); }
        .sop-section-content { padding: 10px 0 10px 10px; border-left: 2px dashed var(--divider); margin-left: 10px; }
        .sop-section-content.hidden { display: none; }
        .sop-item-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .sop-item-name { flex: 1; font-size: 0.95rem; }
        .sop-item-date { width: 120px; flex-shrink: 0; }
        .btn-sop-add { background: none; border: 1px dashed var(--blue); color: var(--blue); width: 100%; padding: 8px; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 0.85rem; }
        .btn-sop-del { color: var(--red); background: none; border: none; cursor: pointer; font-size: 1.1rem; }
        .sop-template-title-input { background: transparent; border: none; border-bottom: 1px solid var(--divider); color: var(--blue); font-weight: bold; width: 80%; font-size: 1rem; }
        .sop-template-title-input:focus { outline: none; border-bottom-color: var(--blue); }

        /* Original Components */
        .payment-row { display: flex; flex-direction: row; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-top: 10px; }
        .pay-col-check { flex: 0 0 30px; display: flex; justify-content: center; }
        .pay-col-name { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .pay-col-info { flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .pay-accordion-header { background: var(--surface-color); padding: 12px 15px; margin-top: 15px; border-radius: 8px; border-left: 5px solid var(--teal); display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; color: var(--teal); }
        .pay-accordion-content.hidden { display: none; }
        .menu-btn { display: block; width: 100%; padding: 20px; margin-bottom: 15px; background: var(--surface-color); color: var(--text-primary); border: 1px solid var(--divider); border-radius: 12px; font-size: 1.1rem; text-align: left; cursor: pointer; position: relative; } 
        .menu-btn .count-badge { float: right; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.9rem; color: var(--text-secondary); }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--blue); color: #202124; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 200; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; } .modal-content { background: var(--surface-color); padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; }
        .btn-manual-move { background: rgba(255,255,255,0.1); border: 1px solid var(--divider); color: var(--text-secondary); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }
    </style>
</head>
<body>

    <div id="loading-overlay" style="display:none;"><div id="loading-msg">Ë≥áÊñôËºâÂÖ•‰∏≠...</div></div>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-top:0; color:var(--blue);">Â∞çÈåØÁ©∫ÈñìÂØ¶È©óÂÆ§</h2>
            <input type="email" id="login-email" class="login-input" placeholder="ÈõªÂ≠ê‰ø°ÁÆ±">
            <input type="password" id="login-password" class="login-input" placeholder="ÂØÜÁ¢º">
            <button class="login-btn" onclick="performLogin()">ÁôªÂÖ•</button>
            <div id="login-error" style="color:var(--red); font-size:0.9rem; margin-top:10px;"></div>
        </div>
    </div>

    <header>
        <button id="back-btn" class="header-back" onclick="goBack()">‚Äπ ËøîÂõû</button>
        <h1 id="page-title">Â∞çÈåØÁ©∫ÈñìÂØ¶È©óÂÆ§</h1>
        <button onclick="logout()" style="position:absolute; right:15px; background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.9rem;">ÁôªÂá∫</button>
    </header>

    <div id="home-page" class="page active container">
        <div id="alert-dashboard" class="alert-section">
            <div style="font-weight:bold; color:var(--red); margin-bottom:10px;">‚ö†Ô∏è ÈáçË¶ÅÊèêÈÜí</div>
            <div id="alert-list"></div>
        </div>
        <!-- Calendar Áï• -->
        <button class="menu-btn" onclick="navigateTo('design-list-page')">Ë®≠Ë®àÊ°à‰ª∂ <span id="cnt-design" class="count-badge">0</span></button>
        <button class="menu-btn" onclick="navigateTo('engineering-list-page')">Â∑•Á®ãÊ°à‰ª∂ <span id="cnt-eng" class="count-badge">0</span></button>
        <button class="menu-btn" onclick="navigateTo('warranty-list-page')" style="border-left: 5px solid var(--purple);">ÂÆåÂ∑•‰øùÂõ∫ <span id="cnt-warranty" class="count-badge">0</span></button>
        <button class="menu-btn" onclick="navigateTo('payment-page')" style="border-left: 5px solid var(--teal);">Êî∂Ê¨æÈÄ≤Â∫¶</button>
        <button class="menu-btn" onclick="navigateTo('sop-main-page')" style="border-left: 5px solid var(--blue);">SOP ÁÆ°ÁêÜÁ≥ªÁµ±</button>
    </div>

    <!-- SOP ‰∏ªÈ†ÅÈù¢ -->
    <div id="sop-main-page" class="page container">
        <div class="detail-title">ÁØÑÊú¨Ë®≠ÂÆö</div>
        <button class="menu-btn" onclick="openSOPTemplate('design')">üõ†Ô∏è Á∑®ËºØË®≠Ë®àÊ°à‰ª∂ SOP ÁØÑÊú¨</button>
        <button class="menu-btn" onclick="openSOPTemplate('engineering')">üõ†Ô∏è Á∑®ËºØÂ∑•Á®ãÊ°à‰ª∂ SOP ÁØÑÊú¨</button>
        <div class="detail-title">Ê°à‰ª∂ SOP Âü∑Ë°åÂàóË°®</div>
        <div class="pay-accordion-header" onclick="toggleElement('sop-design-list')">Ë®≠Ë®àÊ°à‰ª∂ SOP</div>
        <div id="sop-design-list" class="pay-accordion-content"></div>
        <div class="pay-accordion-header" onclick="toggleElement('sop-eng-list')">Â∑•Á®ãÊ°à‰ª∂ SOP</div>
        <div id="sop-eng-list" class="pay-accordion-content"></div>
    </div>

    <!-- SOP ÁØÑÊú¨Á∑®ËºØÈ†ÅÈù¢ -->
    <div id="sop-template-page" class="page container">
        <div id="sop-template-editor-container"></div>
        <button class="btn-sop-add" onclick="addSOPTemplateSection()">+ Êñ∞Â¢ûÈöéÊÆµÊ®ôÈ°å</button>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="login-btn" onclick="saveSOPTemplate()">ÂÑ≤Â≠òÁØÑÊú¨</button>
        </div>
    </div>

    <!-- SOP Ê°à‰ª∂Ë©≥ÊÉÖÈ†ÅÈù¢ -->
    <div id="sop-instance-page" class="page container">
        <div class="detail-section">
            <div id="sop-instance-info-header" style="margin-bottom:15px; border-bottom:1px solid var(--divider); padding-bottom:10px;"></div>
            <div id="sop-instance-body"></div>
        </div>
    </div>

    <!-- ÂÖ∂‰ªñÂéüÊú¨ÁöÑ List È†ÅÈù¢ -->
    <div id="design-list-page" class="page container"><div id="design-list-container"></div><div class="fab" onclick="openAddModal('design')">+</div></div>
    <div id="engineering-list-page" class="page container"><div id="engineering-list-container"></div><div class="fab" onclick="openAddModal('engineering')">+</div></div>
    <div id="warranty-list-page" class="page container"><div id="warranty-list-container"></div></div>
    <div id="payment-page" class="page container">
        <div class="payment-tabs"><button class="tab-btn active" id="tab-design" onclick="switchPaymentTab('design')">Ë®≠Ë®àÂêàÁ¥Ñ</button><button class="tab-btn" id="tab-engineering" onclick="switchPaymentTab('engineering')">Â∑•Á®ãÂêàÁ¥Ñ</button></div>
        <div id="payment-content-container"></div>
    </div>

    <div id="project-detail-page" class="page container">
        <div class="detail-section">
            <div class="detail-title">Âü∫Êú¨Ë≥áÊñô</div>
            <div class="input-row"><label class="input-label">Ê°à‰ª∂ÂêçÁ®±</label><input type="text" class="detail-input" id="d-name" onchange="updateField('name', this.value)"></div>
            <div class="input-row" style="display:flex; gap:10px;">
                <div style="flex:1"><label class="input-label">Ê•≠‰∏ªÂßìÂêç</label><input type="text" class="detail-input" id="d-client" onchange="updateField('client', this.value)"></div>
                <div style="flex:1"><label class="input-label">ËÅØÁµ°ÈõªË©±</label><input type="text" class="detail-input" id="d-phone" onchange="updateField('phone', this.value)"></div>
            </div>
            <div class="input-row"><label class="input-label">Ê°à‰ª∂Âú∞ÂùÄ</label><input type="text" class="detail-input" id="d-address" onchange="updateField('address', this.value)"></div>
        </div>
        <div id="action-bar-container" style="display:flex; gap:10px; margin-top:20px;"></div>
    </div>

    <div id="add-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Êñ∞Â¢ûÊ°à‰ª∂</h3>
            <input type="text" class="detail-input" id="new-name" placeholder="Ê°à‰ª∂ÂêçÁ®±">
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button onclick="closeAddModal()" style="background:none; border:1px solid var(--divider); color:white; padding:8px 15px; border-radius:20px;">ÂèñÊ∂à</button>
                <button class="login-btn" onclick="createProject()" style="width:auto; padding:8px 25px;">Âª∫Á´ã</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDEKjRwWI6vkCg-dIsv1I4BamcC34UaJTU",
            authDomain: "te-interiorlab.firebaseapp.com",
            projectId: "te-interiorlab",
            storageBucket: "te-interiorlab.firebasestorage.app",
            messagingSenderId: "402097472858",
            appId: "1:402097472858:web:e21b7e698c848efa271f63",
            measurementId: "G-RLWZVP7R3Z"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let designProjects = [], engProjects = [], sopTemplates = {}, currentSOPType = '', activeSOPInstance = null;
        let currentType = '', currentId = '', calDate = new Date(), addModeType = '';

        function safe(str) { return str ? String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;") : ''; }
        function formatNumber(num) { return num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : ''; }

        window.onload = () => {
            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('login-overlay').style.display = 'none';
                    initFirestoreListeners();
                } else {
                    document.getElementById('login-overlay').style.display = 'flex';
                }
            });
        };

        function performLogin() {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
        }
        function logout() { auth.signOut().then(() => location.reload()); }

        function initFirestoreListeners() {
            db.collection("design_projects").onSnapshot(snap => { designProjects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); refreshUI(); });
            db.collection("eng_projects").onSnapshot(snap => { engProjects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); refreshUI(); });
            db.collection("sop_templates").onSnapshot(snap => { snap.docs.forEach(doc => { sopTemplates[doc.id] = doc.data(); }); });
        }

        function refreshUI() {
            document.getElementById('cnt-design').innerText = designProjects.filter(p=>p.status!=='completed').length;
            document.getElementById('cnt-eng').innerText = engProjects.filter(p=>p.status==='active'||p.status==='suspended').length;
            document.getElementById('cnt-warranty').innerText = engProjects.filter(p=>p.status==='warranty').length;
            if(document.getElementById('sop-main-page').classList.contains('active')) renderSOPMain();
        }

        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.getElementById('back-btn').style.display = (pageId === 'home-page' ? 'none' : 'block');
            if (pageId === 'sop-main-page') renderSOPMain();
        }

        function goBack() {
            const activePage = document.querySelector('.page.active').id;
            if (activePage === 'sop-template-page' || activePage === 'sop-instance-page') navigateTo('sop-main-page');
            else navigateTo('home-page');
        }

        function toggleElement(id) { document.getElementById(id).classList.toggle('hidden'); }

        // --- SOP ÁØÑÊú¨Á∑®ËºØÈÇèËºØ ---
        function openSOPTemplate(type) {
            currentSOPType = type;
            const container = document.getElementById('sop-template-editor-container');
            container.innerHTML = `<div class="detail-title">Á∑®ËºØ ${type==='design'?'Ë®≠Ë®à':'Â∑•Á®ã'} SOP ÁØÑÊú¨</div>`;
            
            const temp = sopTemplates[type] || { sections: [] };
            temp.sections.forEach((sec, sIdx) => {
                const secDiv = document.createElement('div');
                secDiv.className = 'detail-section';
                secDiv.innerHTML = `
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="text" class="sop-template-title-input" value="${safe(sec.title)}" onchange="updateSOPTempSection(${sIdx}, this.value)">
                        <button class="btn-sop-del" onclick="removeSOPTempSection(${sIdx})">üóëÔ∏è</button>
                    </div>
                    <div id="temp-tasks-${sIdx}"></div>
                    <button class="btn-sop-add" onclick="addSOPTempTask(${sIdx})">+ Êñ∞Â¢û‰ªªÂãôÈ†ÖÁõÆ</button>
                `;
                sec.tasks.forEach((task, tIdx) => {
                    const taskRow = document.createElement('div');
                    taskRow.className = 'sop-item-row';
                    taskRow.innerHTML = `
                        <input type="text" class="detail-input" style="flex:1" value="${safe(task)}" onchange="updateSOPTempTask(${sIdx}, ${tIdx}, this.value)">
                        <button class="btn-sop-del" onclick="removeSOPTempTask(${sIdx}, ${tIdx})">√ó</button>
                    `;
                    secDiv.querySelector(`#temp-tasks-${sIdx}`).appendChild(taskRow);
                });
                container.appendChild(secDiv);
            });
            navigateTo('sop-template-page');
        }

        function updateSOPTempSection(sIdx, val) { sopTemplates[currentSOPType].sections[sIdx].title = val; }
        function removeSOPTempSection(sIdx) { sopTemplates[currentSOPType].sections.splice(sIdx, 1); openSOPTemplate(currentSOPType); }
        function addSOPTemplateSection() {
            if(!sopTemplates[currentSOPType]) sopTemplates[currentSOPType] = { sections: [] };
            sopTemplates[currentSOPType].sections.push({ title: "Êñ∞ÈöéÊÆµÊ®ôÈ°å", tasks: [] });
            openSOPTemplate(currentSOPType);
        }
        function updateSOPTempTask(sIdx, tIdx, val) { sopTemplates[currentSOPType].sections[sIdx].tasks[tIdx] = val; }
        function addSOPTempTask(sIdx) { sopTemplates[currentSOPType].sections[sIdx].tasks.push("Êñ∞‰ªªÂãô"); openSOPTemplate(currentSOPType); }
        function removeSOPTempTask(sIdx, tIdx) { sopTemplates[currentSOPType].sections[sIdx].tasks.splice(tIdx, 1); openSOPTemplate(currentSOPType); }

        async function saveSOPTemplate() {
            document.getElementById('loading-overlay').style.display = 'flex';
            await db.collection("sop_templates").doc(currentSOPType).set(sopTemplates[currentSOPType]);
            document.getElementById('loading-overlay').style.display = 'none';
            alert('ÁØÑÊú¨Â∑≤ÂÑ≤Â≠ò');
        }

        // --- SOP ÂØ¶‰æãÂü∑Ë°åÈÇèËºØ ---
        function renderSOPMain() {
            const dList = document.getElementById('sop-design-list');
            const eList = document.getElementById('sop-eng-list');
            dList.innerHTML = ''; eList.innerHTML = '';

            designProjects.forEach(p => {
                dList.innerHTML += `<button class="menu-btn" onclick="openSOPInstance('${p.id}', 'design')">${safe(p.name)} <span class="count-badge">${safe(p.client)}</span></button>`;
            });
            engProjects.forEach(p => {
                eList.innerHTML += `<button class="menu-btn" onclick="openSOPInstance('${p.id}', 'engineering')">${safe(p.name)} <span class="count-badge">${safe(p.client)}</span></button>`;
            });
        }

        async function openSOPInstance(projectId, type) {
            document.getElementById('loading-overlay').style.display = 'flex';
            const snap = await db.collection("sop_instances").where("projectId", "==", projectId).get();
            const proj = (type==='design' ? designProjects : engProjects).find(x => x.id === projectId);
            
            if (snap.empty) {
                // Ëá™ÂãïÊ†πÊìöÁØÑÊú¨ÊàêÁ´ã SOP (ÂõûÊ∫ØÊîØÊè¥)
                const template = sopTemplates[type] || { sections: [] };
                const newInst = {
                    projectId: projectId,
                    projectName: proj.name,
                    client: proj.client || '',
                    type: type,
                    sections: template.sections.map(s => ({
                        title: s.title,
                        tasks: s.tasks.map(t => ({ name: t, done: false, date: '' }))
                    }))
                };
                const docRef = await db.collection("sop_instances").add(newInst);
                activeSOPInstance = { id: docRef.id, ...newInst };
            } else {
                activeSOPInstance = { id: snap.docs[0].id, ...snap.docs[0].data() };
            }
            renderSOPInstance();
            document.getElementById('loading-overlay').style.display = 'none';
            navigateTo('sop-instance-page');
        }

        function renderSOPInstance() {
            document.getElementById('sop-instance-info-header').innerHTML = `
                <div style="font-weight:bold; color:var(--blue); font-size:1.1rem;">${safe(activeSOPInstance.projectName)}</div>
                <div style="font-size:0.85rem; color:var(--text-secondary)">Ê•≠‰∏ªÔºö${safe(activeSOPInstance.client)}</div>
            `;
            const body = document.getElementById('sop-instance-body');
            body.innerHTML = '';

            activeSOPInstance.sections.forEach((sec, sIdx) => {
                const secDiv = document.createElement('div');
                secDiv.innerHTML = `
                    <div class="sop-section-header" onclick="this.nextElementSibling.classList.toggle('hidden'); this.classList.toggle('collapsed')">
                        <span style="font-weight:bold">${safe(sec.title)}</span>
                    </div>
                    <div class="sop-section-content"></div>
                `;
                const content = secDiv.querySelector('.sop-section-content');
                sec.tasks.forEach((task, tIdx) => {
                    const row = document.createElement('div');
                    row.className = 'sop-item-row';
                    row.innerHTML = `
                        <div class="custom-checkbox ${task.done?'checked':''}" onclick="toggleSOPTask(${sIdx}, ${tIdx})"></div>
                        <div class="sop-item-name">${safe(task.name)}</div>
                        <input type="date" class="mini-date sop-item-date" value="${task.date}" onchange="updateSOPTaskDate(${sIdx}, ${tIdx}, this.value)">
                    `;
                    content.appendChild(row);
                });
                body.appendChild(secDiv);
            });
        }

        async function toggleSOPTask(sIdx, tIdx) {
            activeSOPInstance.sections[sIdx].tasks[tIdx].done = !activeSOPInstance.sections[sIdx].tasks[tIdx].done;
            renderSOPInstance();
            await db.collection("sop_instances").doc(activeSOPInstance.id).update({ sections: activeSOPInstance.sections });
        }
        async function updateSOPTaskDate(sIdx, tIdx, val) {
            activeSOPInstance.sections[sIdx].tasks[tIdx].date = val;
            await db.collection("sop_instances").doc(activeSOPInstance.id).update({ sections: activeSOPInstance.sections });
        }

        // --- Ê†∏ÂøÉÈÇèËºØ‰øÆÊîπÔºöÊñ∞Â¢ûÊ°à‰ª∂ÊôÇÈÄ£Âãï SOP ---
        async function createProject() {
            const name = document.getElementById('new-name').value;
            if (!name) return alert("Ë´ãËº∏ÂÖ•Ê°à‰ª∂ÂêçÁ®±");
            const collection = addModeType === 'design' ? "design_projects" : "eng_projects";
            const newObj = { name: name, status: 'active', createdAt: firebase.firestore.FieldValue.serverTimestamp() };
            
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const docRef = await db.collection(collection).add(newObj);
                
                // Ëá™ÂãïÊàêÁ´ãÊâÄÂ±¨ SOP
                const template = sopTemplates[addModeType] || { sections: [] };
                const sopInst = {
                    projectId: docRef.id,
                    projectName: name,
                    client: '',
                    type: addModeType,
                    sections: template.sections.map(s => ({
                        title: s.title,
                        tasks: s.tasks.map(t => ({ name: t, done: false, date: '' }))
                    }))
                };
                await db.collection("sop_instances").add(sopInst);

                document.getElementById('loading-overlay').style.display = 'none';
                closeAddModal();
                openDetail(addModeType, docRef.id);
            } catch (e) {
                document.getElementById('loading-overlay').style.display = 'none';
                alert(e.message);
            }
        }

        // --- ÂéüÊúâÂü∫Á§éÂäüËÉΩ (Áï•) ---
        function openAddModal(t) { addModeType = t; document.getElementById('modal-title').innerText = t==='design'?'Êñ∞Â¢ûË®≠Ë®à':'Êñ∞Â¢ûÂ∑•Á®ã'; document.getElementById('add-modal').style.display='flex'; }
        function closeAddModal() { document.getElementById('add-modal').style.display='none'; }
        function openDetail(type, id) {
            currentType = type; currentId = id;
            const list = type === 'design' ? designProjects : engProjects;
            const p = list.find(x => x.id === id);
            document.getElementById('d-name').value = p.name || '';
            document.getElementById('d-client').value = p.client || '';
            navigateTo('project-detail-page');
        }
        async function updateField(k, v) { await db.collection(currentType==='design'?"design_projects":"eng_projects").doc(currentId).update({[k]:v}); }
        function changeMonth(n) { calDate.setMonth(calDate.getMonth()+n); /* renderCalendar logic */ }
    </script>
</body>
</html>
