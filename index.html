<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°éŒ¯ç©ºé–“ v26.0 (SOP Template System)</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#202124">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        :root { --bg-color: #202124; --surface-color: #303134; --text-primary: #e8eaed; --text-secondary: #9aa0a6; --divider: #3c4043; --blue: #8ab4f8; --red: #f28b82; --green: #81c995; --yellow: #fdd663; --orange: #fcad70; --purple: #c58af9; --teal: #64ffda; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-primary); -webkit-tap-highlight-color: transparent; padding-bottom: 90px; overscroll-behavior-y: none; }
        button, input, textarea, select { font-family: inherit; }
        header { background-color: var(--surface-color); padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--divider); display: flex; align-items: center; justify-content: center; }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 500; }
        .header-back { position: absolute; left: 15px; background: none; border: none; font-size: 1rem; color: var(--blue); cursor: pointer; display: none; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .page { display: none; } .page.active { display: block; }
        
        /* Overlays */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; color:white; font-size:1.2rem; flex-direction: column; gap:10px; text-align: center; padding: 20px;}
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .login-box { background: var(--surface-color); padding: 30px; border-radius: 12px; width: 100%; max-width: 320px; text-align: center; border: 1px solid var(--divider); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(0,0,0,0.2); border: 1px solid var(--divider); color: var(--text-primary); border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .login-btn { width: 100%; padding: 12px; background: var(--blue); color: #202124; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        
        /* Calendar */
        .calendar-section { background: var(--surface-color); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-day-name { color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 5px; }
        .cal-date { border-radius: 6px; font-size: 0.85rem; cursor: pointer; position: relative; height: 48px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 4px; background: rgba(255,255,255,0.02); }
        .cal-date.active { background-color: rgba(138, 180, 248, 0.2); color: var(--blue); font-weight: bold; border: 1px solid var(--blue); }
        .cal-bar-container { width: 100%; display: flex; flex-direction: column; gap: 2px; margin-top: 2px; align-items: center; }
        .cal-bar { width: 85%; height: 3px; border-radius: 2px; }
        .bar-design { background-color: var(--blue); } .bar-eng { background-color: var(--yellow); } .bar-warranty { background-color: var(--purple); }
        .event-list-box { margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--divider); font-size: 0.9rem; color: var(--text-secondary); min-height: 20px;}
        .event-item { margin-bottom: 8px; display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; cursor: pointer; background: rgba(255,255,255,0.03); }
        .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

        /* UI Elements */
        .alert-section { background-color: rgba(242, 139, 130, 0.15); border: 1px solid var(--red); border-radius: 12px; padding: 15px; margin-bottom: 20px; display: none; }
        .alert-item { color: var(--red); font-size: 0.9rem; margin-bottom: 8px; cursor: pointer; padding-bottom: 5px; border-bottom: 1px solid rgba(242, 139, 130, 0.3); }
        .project-card { background: var(--surface-color); border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid var(--divider); position: relative; overflow: hidden; cursor: pointer; z-index: 1; }
        .progress-bg { position: absolute; bottom: 0; left: 0; height: 4px; width: 100%; background: #444; z-index: 0; }
        .progress-fill { height: 100%; transition: width 0.3s; background: linear-gradient(to right, var(--green), var(--yellow)); }
        .tag { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
        .tag-track { background: var(--yellow); color: #333; } .tag-done { background: var(--green); color: #333; } .tag-suspend { background: var(--red); color: white; } .tag-warranty { background: var(--purple); color: white; }
        .card-progress-text { font-size: 0.85rem; color: var(--teal); margin-top: 5px; display: flex; align-items: center; gap: 5px; } .card-progress-text::before { content: 'â–º'; font-size: 0.7rem; }

        /* Detail Page */
        .detail-section { background: var(--surface-color); padding: 20px; border-radius: 12px; margin-bottom: 15px; }
        .detail-title { font-size: 0.9rem; font-weight: bold; color: var(--blue); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;}
        .input-row { margin-bottom: 15px; } .input-label { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px; display: block; }
        .detail-input { width: 100%; padding: 12px; box-sizing: border-box; background: #202124; border: 1px solid var(--divider); border-radius: 8px; font-size: 1rem; color: var(--text-primary); }
        .detail-input:focus { border-color: var(--blue); outline: none; }

        /* å‹¾é¸æ¬„ä½ç¬¦è™Ÿé¡¯ç¤ºä¿®æ­£ */
        .custom-checkbox { width: 22px; height: 22px; border: 2px solid var(--text-secondary); border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; flex-shrink: 0; transition: background 0.1s; cursor: pointer; color: transparent; font-weight: bold; }
        .checklist-item.checked .custom-checkbox, .custom-checkbox.checked { background: var(--green); border-color: var(--green); color: #202124; } 
        .checklist-item.checked .custom-checkbox::after, .custom-checkbox.checked::after { content: 'âœ“'; }
        
        .mini-date, .pay-date-input { width: 100%; background: #202124; border: 1px solid var(--divider); color: var(--text-primary); padding: 6px 4px; border-radius: 6px; font-size: 0.8rem; color-scheme: dark; white-space: nowrap; overflow: hidden; letter-spacing: -0.3px; }

        /* SOP ç‰¹å®šæ¨£å¼ */
        .sop-section-header { background: #3d3e42; padding: 10px 15px; margin-top: 10px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--blue); }
        .sop-section-content { padding: 10px 0 10px 10px; border-left: 1px dashed var(--divider); margin-bottom: 10px; }
        .sop-item-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .sop-item-name { flex: 1; font-size: 0.9rem; }
        .sop-item-date { width: 110px; }
        .collapsed + .sop-section-content { display: none; }
        .btn-sop-add { font-size: 0.75rem; color: var(--blue); background: none; border: 1px solid var(--blue); padding: 2px 8px; border-radius: 10px; cursor: pointer; }
        .btn-sop-del { color: var(--red); background: none; border: none; cursor: pointer; font-size: 0.9rem; }

        /* æ”¶æ¬¾é€²åº¦ä¸‰æ¬„ä½ˆå±€ CSS */
        .payment-row { display: flex; flex-direction: row; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-top: 10px; position: relative; }
        .pay-col-check { flex: 0 0 30px; display: flex; justify-content: center; align-items: center; }
        .pay-col-name { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .pay-col-info { flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; text-align: right; }
        
        .pay-name-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid transparent; color: var(--text-primary); padding: 4px 0; font-size: 1rem; font-weight: 500; }
        .pay-name-input:focus { border-bottom-color: var(--blue); outline: none; }
        
        .pay-accordion-header { background: var(--surface-color); padding: 12px 15px; margin-top: 15px; border-radius: 8px; border-left: 5px solid var(--teal); display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; color: var(--teal); }
        .pay-accordion-header::after { content: 'â–¼'; font-size: 0.7rem; transition: transform 0.3s; }
        .pay-accordion-header.collapsed::after { transform: rotate(-90deg); }
        .pay-accordion-content { margin-bottom: 20px; }
        .pay-accordion-content.hidden { display: none; }
        .btn-manual-move { background: rgba(255,255,255,0.1); border: 1px solid var(--divider); color: var(--text-secondary); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }

        .payment-tabs { display: flex; border-bottom: 1px solid var(--divider); margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; background: none; border: none; color: var(--text-secondary); border-bottom: 2px solid transparent; cursor: pointer; font-size: 1rem; } .tab-btn.active { color: var(--teal); border-bottom-color: var(--teal); font-weight: bold; }
        .payment-card { background: var(--surface-color); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid var(--teal); }
        .payment-title-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .payment-title { font-weight: bold; font-size: 1.1rem; color: var(--text-primary); } .payment-amount { font-size: 0.9rem; color: var(--yellow); margin-bottom: 10px; }
        
        .menu-btn { display: block; width: 100%; padding: 20px; margin-bottom: 15px; background: var(--surface-color); color: var(--text-primary); border: 1px solid var(--divider); border-radius: 12px; font-size: 1.1rem; text-align: left; cursor: pointer; position: relative; } 
        .menu-btn .count-badge { float: right; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.9rem; color: var(--text-secondary); }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--blue); color: #202124; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 200; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; } .modal-content { background: var(--surface-color); padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; }
        .btn-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; } .btn-primary { background: var(--blue); color: #202124; padding: 10px 20px; border-radius: 20px; border: none; } .btn-cancel { background: transparent; color: var(--text-primary); border: 1px solid var(--divider); padding: 10px 20px; border-radius: 20px; }
        .action-bar { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; } .action-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 0.95rem; cursor: pointer; color: #202124; font-weight: bold; min-width: 100px;} .btn-track { background: var(--yellow); } .btn-del { background: rgba(242,139,130,0.2); color: var(--red); } .btn-done { background: var(--green); } .btn-suspend { background: var(--orange); } .btn-warranty { background: var(--purple); color: white; }
    </style>
</head>
<body>

    <div id="loading-overlay" style="display:none;"><div id="loading-msg">è³‡æ–™è¼‰å…¥ä¸­...</div></div>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-top:0; color:var(--blue);">å°éŒ¯ç©ºé–“å¯¦é©—å®¤</h2>
            <input type="email" id="login-email" class="login-input" placeholder="é›»å­ä¿¡ç®±">
            <input type="password" id="login-password" class="login-input" placeholder="å¯†ç¢¼">
            <button class="login-btn" onclick="performLogin()">ç™»å…¥</button>
            <div id="login-error" style="color:var(--red); font-size:0.9rem; margin-top:10px;"></div>
        </div>
    </div>

    <header>
        <button id="back-btn" class="header-back" onclick="goBack()">â€¹ è¿”å›</button>
        <h1 id="page-title">å°éŒ¯ç©ºé–“å¯¦é©—å®¤</h1>
        <button onclick="logout()" style="position:absolute; right:15px; background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.9rem;">ç™»å‡º</button>
    </header>

    <!-- é¦–é  -->
    <div id="home-page" class="page active container">
        <div id="alert-dashboard" class="alert-section">
            <div style="font-weight:bold; color:var(--red); margin-bottom:10px;">âš ï¸ é‡è¦æé†’</div>
            <div id="alert-list"></div>
        </div>
        <div class="calendar-section">
            <div class="calendar-header">
                <button onclick="changeMonth(-1)" style="background:none; border:none; color:var(--text-primary); font-size:1.5rem">â€¹</button>
                <span id="cal-month-year" style="font-weight:bold;"></span>
                <button onclick="changeMonth(1)" style="background:none; border:none; color:var(--text-primary); font-size:1.5rem">â€º</button>
            </div>
            <div id="calendar-days" class="calendar-grid"></div>
            <div id="calendar-events" class="event-list-box">é»æ“Šæ—¥æœŸæŸ¥çœ‹è¡Œç¨‹</div>
        </div>
        <button class="menu-btn" onclick="navigateTo('design-list-page')">è¨­è¨ˆæ¡ˆä»¶ <span id="cnt-design" class="count-badge">0</span></button>
        <button class="menu-btn" onclick="navigateTo('engineering-list-page')">å·¥ç¨‹æ¡ˆä»¶ <span id="cnt-eng" class="count-badge">0</span></button>
        <button class="menu-btn" onclick="navigateTo('warranty-list-page')" style="border-left: 5px solid var(--purple);">å®Œå·¥ä¿å›º <span id="cnt-warranty" class="count-badge">0</span></button>
        <button class="menu-btn" onclick="navigateTo('payment-page')" style="border-left: 5px solid var(--teal);">æ”¶æ¬¾é€²åº¦</button>
        <button class="menu-btn" onclick="navigateTo('sop-list-page')" style="border-left: 5px solid var(--blue);">SOP ç®¡ç†</button>
    </div>

    <!-- SOP åˆ—è¡¨é é¢ -->
    <div id="sop-list-page" class="page container">
        <div class="detail-title">SOP ç¯„æœ¬è¨­å®š</div>
        <button class="menu-btn" onclick="openSOPTemplate('design')">ğŸ› ï¸ ç·¨è¼¯è¨­è¨ˆæ¡ˆä»¶ SOP ç¯„æœ¬</button>
        <button class="menu-btn" onclick="openSOPTemplate('engineering')">ğŸ› ï¸ ç·¨è¼¯å·¥ç¨‹æ¡ˆä»¶ SOP ç¯„æœ¬</button>
        
        <div class="pay-accordion-header" onclick="togglePaymentAccordion('sop-design-list')">è¨­è¨ˆæ¡ˆä»¶ SOP</div>
        <div id="sop-design-list" class="pay-accordion-content"></div>
        
        <div class="pay-accordion-header" onclick="togglePaymentAccordion('sop-eng-list')">å·¥ç¨‹æ¡ˆä»¶ SOP</div>
        <div id="sop-eng-list" class="pay-accordion-content"></div>
    </div>

    <!-- SOP ç¯„æœ¬ç·¨è¼¯é é¢ -->
    <div id="sop-template-page" class="page container">
        <div class="detail-title">ç¯„æœ¬ç·¨è¼¯ï¼š<span id="sop-temp-type-name"></span></div>
        <div id="sop-template-container"></div>
        <button class="menu-btn" onclick="addSOPTemplateSection()" style="border: 1px dashed var(--blue); text-align: center;">+ æ–°å¢æ¨™é¡Œéšæ®µ</button>
        <div class="action-bar">
            <button class="action-btn btn-done" onclick="saveSOPTemplate()">å„²å­˜ç¯„æœ¬</button>
        </div>
    </div>

    <!-- SOP æ¡ˆä»¶åŸ·è¡Œé é¢ -->
    <div id="sop-instance-page" class="page container">
        <div class="detail-section">
            <div class="detail-title" style="color:var(--blue)">æ¡ˆä»¶ SOP åŸ·è¡Œé€²åº¦</div>
            <div id="sop-inst-info" style="font-size:0.9rem; color:var(--text-secondary); margin-bottom:15px;"></div>
            <div id="sop-instance-container"></div>
        </div>
    </div>

    <div id="design-list-page" class="page container"><div id="design-list-container"></div><div class="fab" onclick="openAddModal('design')">+</div></div>
    <div id="engineering-list-page" class="page container"><div id="engineering-list-container"></div><div class="fab" onclick="openAddModal('engineering')">+</div></div>
    <div id="warranty-list-page" class="page container"><div id="warranty-list-container"></div></div>

    <div id="payment-page" class="page container">
        <div class="payment-tabs"><button class="tab-btn active" id="tab-design" onclick="switchPaymentTab('design')">è¨­è¨ˆåˆç´„</button><button class="tab-btn" id="tab-engineering" onclick="switchPaymentTab('engineering')">å·¥ç¨‹åˆç´„</button></div>
        <div id="payment-content-container"></div>
    </div>

    <div id="project-detail-page" class="page container">
        <div class="detail-section">
            <div class="detail-title">åŸºæœ¬è³‡æ–™</div>
            <div class="input-row"><label class="input-label">æ¡ˆä»¶åç¨±</label><input type="text" class="detail-input" id="d-name" onchange="updateField('name', this.value)"></div>
            <div class="input-row" style="display:flex; gap:10px;">
                <div style="flex:1"><label class="input-label">æ¥­ä¸»å§“å</label><input type="text" class="detail-input" id="d-client" onchange="updateField('client', this.value)"></div>
                <div style="flex:1"><label class="input-label">è¯çµ¡é›»è©±</label><input type="text" class="detail-input" id="d-phone" onchange="updateField('phone', this.value)"></div>
            </div>
            <div class="input-row"><label class="input-label">æ¡ˆä»¶åœ°å€</label><input type="text" class="detail-input" id="d-address" onchange="updateField('address', this.value)"></div>
        </div>
        <div id="action-bar-container" class="action-bar"></div>
    </div>

    <div id="add-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">æ–°å¢æ¡ˆä»¶</h3>
            <input type="text" class="detail-input" id="new-name" placeholder="æ¡ˆä»¶åç¨±">
            <div class="btn-group"><button class="btn-cancel" onclick="closeAddModal()">å–æ¶ˆ</button><button class="btn-primary" onclick="createProject()">å»ºç«‹</button></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDEKjRwWI6vkCg-dIsv1I4BamcC34UaJTU",
            authDomain: "te-interiorlab.firebaseapp.com",
            projectId: "te-interiorlab",
            storageBucket: "te-interiorlab.firebasestorage.app",
            messagingSenderId: "402097472858",
            appId: "1:402097472858:web:e21b7e698c848efa271f63",
            measurementId: "G-RLWZVP7R3Z"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();

        let designProjects = [], engProjects = [], sopTemplates = {}, currentSOPType = '', currentSOPInstance = null;
        let currentType = '', currentId = '', calDate = new Date(), addModeType = '';

        function safe(str) { return str ? String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }
        function formatNumber(num) { return num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : ''; }
        function formatDate(dStr) { return dStr ? dStr.replace(/-/g, '/') : ''; }

        window.onload = () => {
            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('login-overlay').style.display = 'none';
                    initFirestoreListeners();
                } else {
                    document.getElementById('login-overlay').style.display = 'flex';
                }
            });
        };

        function performLogin() {
            const e = document.getElementById('login-email').value, p = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
        }
        function logout() { auth.signOut().then(() => location.reload()); }

        function initFirestoreListeners() {
            db.collection("design_projects").onSnapshot(snap => { designProjects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); refreshUI(); });
            db.collection("eng_projects").onSnapshot(snap => { engProjects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); refreshUI(); });
            db.collection("sop_templates").onSnapshot(snap => {
                snap.docs.forEach(doc => { sopTemplates[doc.id] = doc.data(); });
            });
        }

        function refreshUI() {
            document.getElementById('cnt-design').innerText = designProjects.filter(p=>p.status!=='completed').length;
            document.getElementById('cnt-eng').innerText = engProjects.filter(p=>p.status==='active'||p.status==='suspended').length;
            document.getElementById('cnt-warranty').innerText = engProjects.filter(p=>p.status==='warranty').length;
            if(document.getElementById('sop-list-page').classList.contains('active')) renderSOPList();
        }

        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.getElementById('back-btn').style.display = (pageId === 'home-page' ? 'none' : 'block');
            if(pageId === 'sop-list-page') renderSOPList();
        }

        function goBack() { 
            if(document.getElementById('sop-template-page').classList.contains('active') || document.getElementById('sop-instance-page').classList.contains('active')) navigateTo('sop-list-page');
            else navigateTo('home-page'); 
        }

        // SOP åˆ—è¡¨æ¸²æŸ“
        function renderSOPList() {
            const dList = document.getElementById('sop-design-list');
            const eList = document.getElementById('sop-eng-list');
            dList.innerHTML = ''; eList.innerHTML = '';

            designProjects.forEach(p => {
                dList.innerHTML += `<button class="menu-btn" onclick="openSOPInstance('${p.id}', 'design')">${safe(p.name)} <span class="count-badge">${safe(p.client)}</span></button>`;
            });
            engProjects.forEach(p => {
                eList.innerHTML += `<button class="menu-btn" onclick="openSOPInstance('${p.id}', 'engineering')">${safe(p.name)} <span class="count-badge">${safe(p.client)}</span></button>`;
            });
        }

        // é–‹å•Ÿ SOP ç¯„æœ¬ç·¨è¼¯
        function openSOPTemplate(type) {
            currentSOPType = type;
            document.getElementById('sop-temp-type-name').innerText = type === 'design' ? 'è¨­è¨ˆæ¡ˆä»¶' : 'å·¥ç¨‹æ¡ˆä»¶';
            const container = document.getElementById('sop-template-container');
            container.innerHTML = '';
            
            const data = sopTemplates[type] || { sections: [] };
            data.sections.forEach((sec, sIdx) => {
                container.appendChild(createTemplateSectionUI(sec, sIdx));
            });
            navigateTo('sop-template-page');
        }

        function createTemplateSectionUI(sec, sIdx) {
            const div = document.createElement('div');
            div.className = 'detail-section';
            div.innerHTML = `
                <div class="detail-title">
                    <input type="text" class="pay-name-input" value="${safe(sec.title)}" placeholder="éšæ®µåç¨±" onchange="sopTemplates['${currentSOPType}'].sections[${sIdx}].title = this.value">
                    <button class="btn-sop-del" onclick="removeSOPTemplateSection(${sIdx})">ğŸ—‘ï¸</button>
                </div>
                <div id="sop-tasks-${sIdx}"></div>
                <button class="btn-sop-add" onclick="addSOPTemplateTask(${sIdx})">+ æ–°å¢ä»»å‹™</button>
            `;
            const taskList = div.querySelector(`#sop-tasks-${sIdx}`);
            sec.tasks.forEach((task, tIdx) => {
                const row = document.createElement('div');
                row.className = 'sop-item-row';
                row.innerHTML = `
                    <input type="text" class="detail-input" style="flex:1" value="${safe(task)}" placeholder="ä»»å‹™å…§å®¹" onchange="sopTemplates['${currentSOPType}'].sections[${sIdx}].tasks[${tIdx}] = this.value">
                    <button class="btn-sop-del" onclick="removeSOPTemplateTask(${sIdx}, ${tIdx})">Ã—</button>
                `;
                taskList.appendChild(row);
            });
            return div;
        }

        async function saveSOPTemplate() {
            document.getElementById('loading-overlay').style.display = 'flex';
            await db.collection("sop_templates").doc(currentSOPType).set(sopTemplates[currentSOPType]);
            document.getElementById('loading-overlay').style.display = 'none';
            alert('ç¯„æœ¬å·²å„²å­˜');
        }

        function addSOPTemplateSection() {
            if(!sopTemplates[currentSOPType]) sopTemplates[currentSOPType] = { sections: [] };
            sopTemplates[currentSOPType].sections.push({ title: 'æ–°éšæ®µ', tasks: [] });
            openSOPTemplate(currentSOPType);
        }
        function removeSOPTemplateSection(sIdx) { sopTemplates[currentSOPType].sections.splice(sIdx, 1); openSOPTemplate(currentSOPType); }
        function addSOPTemplateTask(sIdx) { sopTemplates[currentSOPType].sections[sIdx].tasks.push(''); openSOPTemplate(currentSOPType); }
        function removeSOPTemplateTask(sIdx, tIdx) { sopTemplates[currentSOPType].sections[sIdx].tasks.splice(tIdx, 1); openSOPTemplate(currentSOPType); }

        // é–‹å•Ÿæ¡ˆä»¶ SOP å¯¦ä¾‹
        async function openSOPInstance(projectId, type) {
            document.getElementById('loading-overlay').style.display = 'flex';
            const snap = await db.collection("sop_instances").where("projectId", "==", projectId).get();
            let pData = (type === 'design' ? designProjects : engProjects).find(x => x.id === projectId);
            
            if (snap.empty) {
                // è‡ªå‹•å»ºç«‹
                const template = sopTemplates[type] || { sections: [] };
                const newInstance = {
                    projectId: projectId,
                    type: type,
                    projectName: pData.name,
                    client: pData.client || '',
                    sections: template.sections.map(s => ({
                        title: s.title,
                        tasks: s.tasks.map(t => ({ name: t, done: false, date: '' }))
                    }))
                };
                const docRef = await db.collection("sop_instances").add(newInstance);
                currentSOPInstance = { id: docRef.id, ...newInstance };
            } else {
                currentSOPInstance = { id: snap.docs[0].id, ...snap.docs[0].data() };
            }

            renderSOPInstanceUI();
            document.getElementById('loading-overlay').style.display = 'none';
            navigateTo('sop-instance-page');
        }

        function renderSOPInstanceUI() {
            document.getElementById('sop-inst-info').innerText = `${currentSOPInstance.projectName} (${currentSOPInstance.client})`;
            const container = document.getElementById('sop-instance-container');
            container.innerHTML = '';

            currentSOPInstance.sections.forEach((sec, sIdx) => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="sop-section-header" onclick="this.classList.toggle('collapsed')">
                        <span>${safe(sec.title)}</span>
                    </div>
                    <div class="sop-section-content"></div>
                `;
                const taskList = div.querySelector('.sop-section-content');
                sec.tasks.forEach((task, tIdx) => {
                    const row = document.createElement('div');
                    row.className = 'sop-item-row';
                    row.innerHTML = `
                        <div class="custom-checkbox ${task.done?'checked':''}" onclick="toggleSOPTask(${sIdx}, ${tIdx})"></div>
                        <span class="sop-item-name">${safe(task.name)}</span>
                        <input type="date" class="mini-date sop-item-date" value="${task.date}" onchange="updateSOPTaskDate(${sIdx}, ${tIdx}, this.value)">
                    `;
                    taskList.appendChild(row);
                });
                container.appendChild(div);
            });
        }

        async function toggleSOPTask(sIdx, tIdx) {
            currentSOPInstance.sections[sIdx].tasks[tIdx].done = !currentSOPInstance.sections[sIdx].tasks[tIdx].done;
            renderSOPInstanceUI();
            await db.collection("sop_instances").doc(currentSOPInstance.id).update({ sections: currentSOPInstance.sections });
        }
        async function updateSOPTaskDate(sIdx, tIdx, val) {
            currentSOPInstance.sections[sIdx].tasks[tIdx].date = val;
            await db.collection("sop_instances").doc(currentSOPInstance.id).update({ sections: currentSOPInstance.sections });
        }

        // åŸæœ‰æ¡ˆä»¶å»ºç«‹é‚è¼¯å¾®èª¿ï¼Œç¢ºä¿ SOP èƒ½åœ¨å»ºç«‹å¾Œç«‹å³å‚™å¦¥
        async function createProject() {
            const name = document.getElementById('new-name').value;
            if (!name) return alert("è«‹è¼¸å…¥åç¨±");
            const col = addModeType === 'design' ? "design_projects" : "eng_projects";
            const newObj = { name: name, status: 'active', createdAt: firebase.firestore.FieldValue.serverTimestamp() };
            
            document.getElementById('loading-overlay').style.display = 'flex';
            const docRef = await db.collection(col).add(newObj);
            
            // å»ºç«‹æ¡ˆä»¶å¾Œè‡ªå‹•æˆç«‹ SOP
            await openSOPInstance(docRef.id, addModeType); 
            
            closeAddModal();
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // --- å…¶é¤˜åŸæœ‰åŠŸèƒ½ç¶­æŒä¸è®Š ---
        function togglePaymentAccordion(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
            el.previousElementSibling.classList.toggle('collapsed');
        }
        function openAddModal(t) { addModeType = t; document.getElementById('modal-title').innerText = t==='design'?'æ–°å¢è¨­è¨ˆ':'æ–°å¢å·¥ç¨‹'; document.getElementById('add-modal').style.display='flex'; }
        function closeAddModal() { document.getElementById('add-modal').style.display='none'; }
        function changeMonth(n) { calDate.setMonth(calDate.getMonth()+n); renderCalendar(); }
        function renderCalendar() {
            const y = calDate.getFullYear(), m = calDate.getMonth();
            document.getElementById('cal-month-year').innerText = `${y} / ${String(m+1).padStart(2,'0')}`;
            const c = document.getElementById('calendar-days'); c.innerHTML = '';
            for(let i=0; i<new Date(y,m,1).getDay(); i++) c.innerHTML += '<div></div>';
            for(let d=1; d<=new Date(y,m+1,0).getDate(); d++) {
                const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const div = document.createElement('div'); div.className = 'cal-date'; div.innerHTML = `<span>${d}</span>`;
                c.appendChild(div);
            }
        }
    </script>
</body>
</html>
